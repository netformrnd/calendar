<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê´€ë¦¬ì - í•˜ì´ì›ìŠ¤ ë™ê¸°í™”</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css">
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Pretendard', 'Segoe UI', 'Malgun Gothic', sans-serif;
      background: #f5f6f8;
      color: #111;
      line-height: 1.6;
      min-height: 100vh;
      font-size: 14px;
    }

    /* í—¤ë” - vacation-calendar.html ê³¼ ë™ì¼ ìŠ¤íƒ€ì¼ */
    .top-header {
      background: #1e293b;
      padding: 0 28px;
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .top-header h1 { font-size: 15px; font-weight: 700; color: #fff; letter-spacing: -0.3px; }
    .back-link {
      color: rgba(255,255,255,.7);
      text-decoration: none;
      font-size: 13px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: color .15s;
    }
    .back-link:hover { color: #fff; }
    .badge-admin {
      background: #dc2626;
      color: #fff;
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.3px;
    }
    .btn-calendar-link {
      display:inline-flex; align-items:center; gap:5px;
      padding:5px 14px; border-radius:6px;
      font-size:12px; font-weight:600;
      background:rgba(255,255,255,.08); color:#94A3B8;
      border:1px solid #334155; text-decoration:none;
      transition:all .15s; font-family:inherit;
    }
    .btn-calendar-link:hover { background:rgba(255,255,255,.15); color:#fff; }

    .container { max-width: 700px; margin: 0 auto; padding: 24px 20px; }

    .section {
      background: #fff;
      border-radius: 10px;
      padding: 24px;
      margin-bottom: 16px;
      border: 1px solid #e5e7eb;
    }

    .section-title {
      font-size: 15px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 14px;
      padding-bottom: 8px;
      border-bottom: 2px solid #2563eb;
      display: inline-block;
    }

    .desc { font-size: 13px; color: #64748b; margin-bottom: 18px; }

    .warn-box {
      background: #fffbeb;
      border: 1px solid #fde68a;
      border-left: 4px solid #d97706;
      border-radius: 8px;
      padding: 14px 18px;
      font-size: 13px;
      color: #92400e;
      margin-bottom: 18px;
      line-height: 1.7;
    }
    .warn-box strong { color: #78350f; }
    .warn-box a { color: #2563eb; font-weight: 600; }

    /* ìƒíƒœ */
    .status-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-size: 13px; color: #334155; }
    .dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    .dot-ok { background: #16a34a; }
    .dot-err { background: #dc2626; }
    .dot-wait { background: #d1d5db; }
    .dot-loading { background: #d97706; animation: pulse 1s infinite; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: .4; } }

    .btn {
      padding: 8px 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all .15s;
      font-family: inherit;
    }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    .btn-sync {
      background: #2563eb;
      color: #fff;
      width: 100%;
      font-size: 15px;
      padding: 14px;
      border-radius: 10px;
    }
    .btn-sync:hover:not(:disabled) { background: #1d4ed8; }
    .btn-sm { padding: 5px 14px; font-size: 12px; }
    .btn-outline {
      background: #fff;
      color: #475569;
      border: 1px solid #d1d5db;
    }
    .btn-outline:hover { border-color: #2563eb; color: #2563eb; }

    /* ì„¤ì • */
    .month-selector { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; font-size: 14px; color: #334155; }
    .month-selector select {
      padding: 7px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      background: #fff;
      color: #111;
    }
    .month-selector select:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 2px rgba(37,99,235,.15); }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 14px;
      font-size: 13px;
      cursor: pointer;
      color: #334155;
    }
    .checkbox-row input { width: 16px; height: 16px; accent-color: #2563eb; }

    .last-sync { font-size: 12px; color: #94a3b8; margin-top: 10px; }

    /* ê²°ê³¼ */
    .sync-result { margin-top: 12px; }
    .result-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
    .result-label { color: #64748b; }
    .result-value { font-weight: 700; color: #1e293b; }

    /* ë¡œê·¸ */
    .log-area {
      background: #1e293b;
      color: rgba(226,232,240,.9);
      border-radius: 8px;
      padding: 14px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Consolas', 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.9;
      margin-top: 12px;
    }
    .log-ok { color: #4ade80; }
    .log-err { color: #f87171; }
    .log-info { color: #93c5fd; }
    .log-warn { color: #fbbf24; }

    /* í‘¸í„° */
    .footer {
      text-align: center;
      color: #94a3b8;
      font-size: 12px;
      padding: 16px 0;
      border-top: 1px solid #e5e7eb;
      margin-top: 8px;
    }
  </style>
</head>
<body>

<!-- í—¤ë” -->
<div class="top-header">
  <div style="display:flex;align-items:center;gap:12px;">
    <a class="back-link" href="https://netformrnd.github.io/calendar/">&larr; ìº˜ë¦°ë”ë¡œ ëŒì•„ê°€ê¸°</a>
    <h1>í•˜ì´ì›ìŠ¤ ë™ê¸°í™” ê´€ë¦¬</h1>
  </div>
  <div style="display:flex;align-items:center;gap:10px;">
    <a href="https://netformrnd.github.io/calendar/" class="btn-calendar-link">ğŸ“… ìº˜ë¦°ë” ë°”ë¡œê°€ê¸°</a>
    <span class="badge-admin">ê´€ë¦¬ì ì „ìš©</span>
  </div>
</div>

<div class="container">

  <!-- ì•ˆë‚´ -->
  <div class="section">
    <div class="section-title">ì—°ê²° ìƒíƒœ</div>
    <div class="desc">í•˜ì´ì›ìŠ¤ íœ´ê°€ ë°ì´í„°ë¥¼ Firebaseì— ë™ê¸°í™”í•©ë‹ˆë‹¤. í•˜ì´ì›ìŠ¤ì— ë¡œê·¸ì¸ëœ ìƒíƒœì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”.</div>

    <div class="warn-box">
      <strong>ì‚¬ì „ ì¡°ê±´:</strong> ì´ í˜ì´ì§€ë¥¼ ì‚¬ìš©í•˜ê¸° ì „ì— <a href="https://hr-work.office.hiworks.com" target="_blank">í•˜ì´ì›ìŠ¤</a>ì— ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.<br>
      ë™ê¸°í™”ëœ ë°ì´í„°ëŠ” ì „ì‚¬ ìº˜ë¦°ë”ì—ì„œ ëª¨ë“  ì§ì›ì´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </div>

    <div class="status-row">
      <div class="dot dot-wait" id="dotHw"></div>
      <span id="txtHw">í•˜ì´ì›ìŠ¤ - í™•ì¸ ì „</span>
    </div>
    <div class="status-row">
      <div class="dot dot-wait" id="dotFb"></div>
      <span id="txtFb">Firebase - í™•ì¸ ì „</span>
    </div>
    <button class="btn btn-outline btn-sm" onclick="checkConnections()" style="margin-top:8px;">ì—°ê²° í™•ì¸</button>
  </div>

  <!-- ë™ê¸°í™” ì„¤ì • -->
  <div class="section">
    <div class="section-title">ë™ê¸°í™” ì„¤ì •</div>

    <div class="month-selector">
      <label>ëŒ€ìƒ ì›”:</label>
      <select id="selYear"></select>
      <span>ë…„</span>
      <select id="selMonth"></select>
      <span>ì›”</span>
    </div>

    <label class="checkbox-row">
      <input type="checkbox" id="chkMulti" checked>
      ë‹¹ì›” í¬í•¨ +2ê°œì›” (ì´ 3ê°œì›”) ë™ê¸°í™”
    </label>

    <button class="btn btn-sync" id="btnSync" onclick="startSync()">
      ë™ê¸°í™” ì‹¤í–‰
    </button>

    <div class="last-sync" id="lastSync"></div>
  </div>

  <!-- ê²°ê³¼ -->
  <div class="section">
    <div class="section-title">ë™ê¸°í™” ê²°ê³¼</div>
    <div class="sync-result" id="syncResult">
      <div style="color:#94a3b8;font-size:13px;">ì•„ì§ ë™ê¸°í™”ë¥¼ ì‹¤í–‰í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>
    </div>
  </div>

  <!-- ì™¸ë¶€ ì—°ì°¨ê´€ë¦¬ ë°”ë¡œê°€ê¸° -->
  <div class="section">
    <div class="section-title">ì™¸ë¶€ ì—°ì°¨ê´€ë¦¬</div>
    <div class="desc">í•˜ì´ì›ìŠ¤ ë¯¸ì‚¬ìš© ì§ì›ì˜ ì—°ì°¨í˜„í™©ì„ ë³„ë„ë¡œ ê´€ë¦¬í•˜ëŠ” í˜ì´ì§€ì…ë‹ˆë‹¤.</div>
    <a href="https://netformrnd.github.io/sq_vc/" target="_blank" class="btn btn-outline btn-sm" style="display:inline-flex;align-items:center;gap:6px;margin-top:8px;text-decoration:none;">
      ğŸ”— ì™¸ë¶€ ì—°ì°¨ê´€ë¦¬ í˜ì´ì§€ ë°”ë¡œê°€ê¸°
    </a>
  </div>

  <!-- ë¡œê·¸ -->
  <div class="section">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div class="section-title" style="margin-bottom:0;">ì‹¤í–‰ ë¡œê·¸</div>
      <button class="btn btn-outline btn-sm" onclick="clearLog()">ì´ˆê¸°í™”</button>
    </div>
    <div class="log-area" id="logArea">ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...\n</div>
  </div>

  <div class="footer">
    &copy; Netform R&D ê²½ì˜ê´€ë¦¬íŒ€ &middot; í•˜ì´ì›ìŠ¤ ë™ê¸°í™” ê´€ë¦¬
  </div>

</div>

<script>
// ============================================================
// CONFIG
// ============================================================
const HIWORKS_BASE = 'https://hr-work-api.office.hiworks.com/v4';
const HIWORKS_USERS = 'https://office-account-api.office.hiworks.com/v3/users?filter[with_inactivated]=Y&filter[with_deleted]=Y&fields[users]=account_id,name,company_num';
const HIWORKS_VACATION = (y, m) => `${HIWORKS_BASE}/vacation-calendar?filter[year]=${y}&filter[month]=${m}&page[limit]=600&page[offset]=0`;

const FB_CONFIG = {
  apiKey: "AIzaSyCzngaCcenhH1tmZ7syugpI3H1wYBVhiJQ",
  authDomain: "test-168a4.firebaseapp.com",
  databaseURL: "https://test-168a4-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "test-168a4",
  storageBucket: "test-168a4.firebasestorage.app",
  messagingSenderId: "955362696992",
  appId: "1:955362696992:web:234b098db17412be27c145"
};

let fbDB = null;
let hwUserMap = {};

// ============================================================
// INIT
// ============================================================
function init() {
  try {
    const app = firebase.initializeApp(FB_CONFIG, 'syncApp');
    fbDB = firebase.database(app);
  } catch (e) {
    try { fbDB = firebase.database(firebase.app('syncApp')); } catch {}
  }

  const today = new Date();
  const selY = document.getElementById('selYear');
  const selM = document.getElementById('selMonth');
  for (let y = today.getFullYear() - 1; y <= today.getFullYear() + 1; y++) {
    const opt = document.createElement('option');
    opt.value = y; opt.textContent = y;
    if (y === today.getFullYear()) opt.selected = true;
    selY.appendChild(opt);
  }
  for (let m = 1; m <= 12; m++) {
    const opt = document.createElement('option');
    opt.value = m; opt.textContent = m;
    if (m === today.getMonth() + 1) opt.selected = true;
    selM.appendChild(opt);
  }

  loadLastSync();
  checkConnections();
}

// ============================================================
// CONNECTION CHECK
// ============================================================
async function checkConnections() {
  setStatus('dotHw', 'txtHw', 'loading', 'í•˜ì´ì›ìŠ¤ - í™•ì¸ ì¤‘...');
  try {
    const r = await fetch(HIWORKS_USERS, { credentials: 'include' });
    if (r.ok) {
      const data = await r.json();
      const count = (data.data || []).length;
      hwUserMap = {};
      (data.data || []).forEach(u => { hwUserMap[u.id] = u.attributes.name; });
      setStatus('dotHw', 'txtHw', 'ok', `í•˜ì´ì›ìŠ¤ - ì—°ê²°ë¨ (${count}ëª…)`);
      log('í•˜ì´ì›ìŠ¤ ì—°ê²° í™•ì¸ ì™„ë£Œ: ' + count + 'ëª…', 'ok');
    } else {
      setStatus('dotHw', 'txtHw', 'err', 'í•˜ì´ì›ìŠ¤ - ë¡œê·¸ì¸ í•„ìš” (HTTP ' + r.status + ')');
      log('í•˜ì´ì›ìŠ¤ ì—°ê²° ì‹¤íŒ¨: HTTP ' + r.status + ' - í•˜ì´ì›ìŠ¤ì— ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”', 'err');
    }
  } catch (e) {
    setStatus('dotHw', 'txtHw', 'err', 'í•˜ì´ì›ìŠ¤ - ì—°ê²° ì‹¤íŒ¨');
    log('í•˜ì´ì›ìŠ¤ ì—°ê²° ì˜¤ë¥˜: ' + e.message, 'err');
  }

  setStatus('dotFb', 'txtFb', 'loading', 'Firebase - í™•ì¸ ì¤‘...');
  try {
    await fbDB.ref('/hiworks_vacation_sync/meta').once('value');
    setStatus('dotFb', 'txtFb', 'ok', 'Firebase - ì—°ê²°ë¨');
    log('Firebase ì—°ê²° í™•ì¸ ì™„ë£Œ', 'ok');
  } catch (e) {
    setStatus('dotFb', 'txtFb', 'err', 'Firebase - ì—°ê²° ì‹¤íŒ¨');
    log('Firebase ì—°ê²° ì˜¤ë¥˜: ' + e.message, 'err');
  }
}

function setStatus(dotId, txtId, state, text) {
  const dot = document.getElementById(dotId);
  dot.className = 'dot ' + (state === 'ok' ? 'dot-ok' : state === 'err' ? 'dot-err' : state === 'loading' ? 'dot-loading' : 'dot-wait');
  document.getElementById(txtId).textContent = text;
}

// ============================================================
// SYNC - ë‹¹ì›” + 2ê°œì›” (ì´ 3ê°œì›”)
// ============================================================
async function startSync() {
  const btn = document.getElementById('btnSync');
  btn.disabled = true;
  btn.textContent = 'ë™ê¸°í™” ì¤‘...';

  const year = parseInt(document.getElementById('selYear').value);
  const month = parseInt(document.getElementById('selMonth').value);
  const multi = document.getElementById('chkMulti').checked;

  const months = [];
  if (multi) {
    for (let offset = 0; offset <= 2; offset++) {
      let y = year, m = month + offset;
      if (m > 12) { m -= 12; y++; }
      months.push({ year: y, month: m });
    }
  } else {
    months.push({ year, month });
  }

  log(`=== ë™ê¸°í™” ì‹œì‘ (${months.map(m => m.year + 'ë…„ ' + m.month + 'ì›”').join(', ')}) ===`, 'info');

  // 1. ì‚¬ìš©ì ëª©ë¡
  if (Object.keys(hwUserMap).length === 0) {
    log('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì¤‘...', 'info');
    try {
      const r = await fetch(HIWORKS_USERS, { credentials: 'include' });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      const data = await r.json();
      hwUserMap = {};
      (data.data || []).forEach(u => { hwUserMap[u.id] = u.attributes.name; });
      log('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì™„ë£Œ: ' + Object.keys(hwUserMap).length + 'ëª…', 'ok');
    } catch (e) {
      log('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + e.message + ' - í•˜ì´ì›ìŠ¤ ë¡œê·¸ì¸ì„ í™•ì¸í•˜ì„¸ìš”', 'err');
      btn.disabled = false;
      btn.textContent = 'ë™ê¸°í™” ì‹¤í–‰';
      return;
    }
  }

  // 2. ì‚¬ìš©ì ë§µ ì €ì¥
  try {
    await fbDB.ref('/hiworks_vacation_sync/users').set(hwUserMap);
    log('ì‚¬ìš©ì ë§µ ì €ì¥ ì™„ë£Œ', 'ok');
  } catch (e) {
    log('ì‚¬ìš©ì ë§µ ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'err');
  }

  // 3. ê° ì›”ë³„ íœ´ê°€ ë°ì´í„°
  let totalRecords = 0;
  const resultData = {};

  for (const { year: y, month: m } of months) {
    const key = `${y}-${String(m).padStart(2, '0')}`;
    log(`${key} íœ´ê°€ ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” ì¤‘...`, 'info');

    try {
      const r = await fetch(HIWORKS_VACATION(y, m), { credentials: 'include' });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      const data = await r.json();
      const records = data.data || [];

      const enriched = records.map(rec => ({
        ...rec,
        user_name: hwUserMap[String(rec.office_user_no)] || 'ì•Œìˆ˜ì—†ìŒ'
      }));

      await fbDB.ref('/hiworks_vacation_sync/data/' + key).set(enriched);

      totalRecords += records.length;
      resultData[key] = records.length;
      log(`${key}: ${records.length}ê±´ ì €ì¥ ì™„ë£Œ`, 'ok');
    } catch (e) {
      log(`${key} ë™ê¸°í™” ì‹¤íŒ¨: ${e.message}`, 'err');
      resultData[key] = 'ì‹¤íŒ¨';
    }
  }

  // 4. ë©”íƒ€ ì •ë³´
  const syncTime = new Date().toISOString();
  try {
    await fbDB.ref('/hiworks_vacation_sync/meta').set({
      lastSync: syncTime,
      syncedMonths: months.map(m => `${m.year}-${String(m.month).padStart(2, '0')}`),
      totalRecords: totalRecords,
      syncedBy: 'admin'
    });
  } catch {}

  log(`=== ë™ê¸°í™” ì™„ë£Œ! ì´ ${totalRecords}ê±´ ì €ì¥ ===`, 'ok');

  showResult(resultData, totalRecords, syncTime);
  loadLastSync();

  btn.disabled = false;
  btn.textContent = 'ë™ê¸°í™” ì‹¤í–‰';
}

function showResult(data, total, time) {
  const el = document.getElementById('syncResult');
  let html = '';
  for (const [key, count] of Object.entries(data)) {
    const val = typeof count === 'number' ? count + 'ê±´' : count;
    html += `<div class="result-row"><span class="result-label">${key}</span><span class="result-value">${val}</span></div>`;
  }
  html += `<div class="result-row" style="border-top:2px solid #e5e7eb;margin-top:4px;padding-top:10px;"><span class="result-label"><strong>í•©ê³„</strong></span><span class="result-value"><strong>${total}ê±´</strong></span></div>`;
  html += `<div style="font-size:12px;color:#94a3b8;margin-top:8px;">ë™ê¸°í™” ì‹œê°„: ${new Date(time).toLocaleString('ko-KR')}</div>`;
  el.innerHTML = html;
}

function loadLastSync() {
  if (!fbDB) return;
  fbDB.ref('/hiworks_vacation_sync/meta/lastSync').once('value').then(snap => {
    const val = snap.val();
    document.getElementById('lastSync').textContent = val
      ? 'ë§ˆì§€ë§‰ ë™ê¸°í™”: ' + new Date(val).toLocaleString('ko-KR')
      : 'ì•„ì§ ë™ê¸°í™”í•œ ì  ì—†ìŒ';
  });
}

// ============================================================
// LOG
// ============================================================
function log(msg, type) {
  const area = document.getElementById('logArea');
  const time = new Date().toLocaleTimeString('ko-KR');
  const cls = type === 'ok' ? 'log-ok' : type === 'err' ? 'log-err' : type === 'warn' ? 'log-warn' : 'log-info';
  area.innerHTML += `<div class="${cls}">[${time}] ${msg}</div>`;
  area.scrollTop = area.scrollHeight;
}

function clearLog() {
  document.getElementById('logArea').innerHTML = '';
}

// START
init();
</script>
</body>
</html>
