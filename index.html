<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>(ì£¼) ë„·í¼ì•Œì•¤ë”” ê·¼ë¬´í˜„í™© ìº˜ë¦°ë”</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap">
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Pretendard','Segoe UI','Malgun Gothic',sans-serif;
      background:#F1F5F9; color:#0F172A; min-height:100vh;
      -webkit-font-smoothing:antialiased;
    }

    /* â”€â”€ ìƒë‹¨ í—¤ë” â”€â”€ */
    .top-header {
      background:linear-gradient(180deg,#0F172A 0%,#1E293B 100%);
      padding:0 30px; height:56px;
      display:flex; justify-content:space-between; align-items:center;
      position:sticky; top:0; z-index:100;
    }
    .top-header h1 { font-size:1.1rem; font-weight:700; color:#fff; letter-spacing:-0.3px; }
    .hdr-right { display:flex; align-items:center; gap:12px; }
    .hdr-right .sync { font-size:0.75rem; color:#64748B; }
    .hdr-btn {
      padding:6px 16px; border-radius:6px; font-size:0.8rem; font-weight:600;
      cursor:pointer; text-decoration:none; font-family:inherit; border:none; transition:all .15s;
    }
    .hdr-btn.ghost { background:rgba(255,255,255,.08); color:#94A3B8; border:1px solid #334155; }
    .hdr-btn.ghost:hover { background:rgba(255,255,255,.15); color:#fff; }
    .hdr-btn.blue { background:#3B82F6; color:#fff; }
    .hdr-btn.blue:hover { background:#2563EB; }

    /* â”€â”€ ë©”ì¸ ì„¹ì…˜ â”€â”€ */
    .main-section {
      max-width:1340px; margin:20px auto 40px; background:#fff;
      border-radius:16px; box-shadow:0 4px 24px rgba(0,0,0,.08); overflow:hidden;
    }

    /* â”€â”€ ê²€ìƒ‰ â”€â”€ */
    .search-area { padding:16px 24px 0; background:#F8FAFC; border-bottom:1px solid #E2E8F0; }
    .search-card { background:#fff; border:1.5px solid #E2E8F0; border-radius:14px; overflow:hidden; margin-bottom:16px; box-shadow:0 2px 12px rgba(0,0,0,.05); }
    .search-header { padding:18px 22px 16px; display:flex; align-items:center; gap:14px; }
    .search-header-icon { width:40px; height:40px; border-radius:10px; background:linear-gradient(135deg,#B4CEF9,#D4C4FC); display:flex; align-items:center; justify-content:center; flex-shrink:0; }
    .search-header-icon svg { width:20px; height:20px; color:#fff; fill:none; stroke:currentColor; stroke-width:2.2; stroke-linecap:round; stroke-linejoin:round; }
    .search-header-title { font-size:1rem; font-weight:800; color:#0F172A; margin-bottom:1px; }
    .search-header-desc { font-size:0.85rem; color:#F59E0B; font-weight:700; margin-top:2px; }
    .search-input-row { padding:0 22px 18px; }
    .search-input-wrap { position:relative; }
    .search-input { width:100%; padding:14px 42px 14px 44px; border:1.5px solid #E2E8F0; border-radius:12px; font-size:1rem; font-family:inherit; color:#0F172A; background:#F8FAFC; transition:border .15s,background .15s,box-shadow .15s; }
    .search-input:focus { outline:none; border-color:#B4CEF9; background:#fff; box-shadow:0 0 0 4px rgba(180,206,249,.2); }
    .search-input::placeholder { color:#CBD5E1; }
    .search-clear {
      position:absolute; right:12px; top:50%; transform:translateY(-50%);
      width:24px; height:24px; border:none; border-radius:50%; background:#E2E8F0;
      color:#64748B; font-size:14px; cursor:pointer; display:none;
      align-items:center; justify-content:center; transition:all .15s;
    }
    .search-clear.show { display:flex; }
    .search-clear:hover { background:#CBD5E1; color:#0F172A; }
    .search-si { position:absolute; left:15px; top:50%; transform:translateY(-50%); width:20px; height:20px; color:#94A3B8; fill:none; stroke:currentColor; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; }
    .search-result { display:none; border-top:1px solid #F1F5F9; }
    .search-result.show { display:block; }
    .sr-card { padding:24px 28px; display:flex; align-items:center; gap:20px; background:linear-gradient(180deg,rgba(180,206,249,.06),rgba(180,206,249,.12)); }
    .sr-card.on-work { background:linear-gradient(180deg,rgba(167,243,208,.08),rgba(167,243,208,.20)); }
    .sr-card.on-leave { background:linear-gradient(180deg,rgba(255,174,185,.08),rgba(255,174,185,.18)); }
    .sr-avatar { width:58px; height:58px; border-radius:50%; background:linear-gradient(135deg,#B4CEF9,#D4C4FC); display:flex; align-items:center; justify-content:center; font-size:1.2rem; font-weight:700; color:#fff; flex-shrink:0; box-shadow:0 2px 8px rgba(180,206,249,.3); }
    .sr-info { flex:1; }
    .sr-name { font-size:1.25rem; font-weight:800; color:#0F172A; margin-bottom:4px; }
    .sr-detail { font-size:0.92rem; color:#64748B; }
    .sr-badge { display:inline-flex; padding:10px 22px; border-radius:28px; font-size:0.92rem; font-weight:600; flex-shrink:0; letter-spacing:0.3px; }
    .sr-badge.working { background:#D1FAE5; color:#065F46; }
    .sr-badge.vac { background:rgba(253,164,175,.25); color:#BE123C; }
    .sr-badge.half-am,.sr-badge.half-pm { background:rgba(253,164,175,.25); color:#BE123C; }
    .sr-badge.out { background:rgba(212,196,252,.35); color:#5B21B6; }
    .sr-badge.off-hours { background:rgba(148,163,184,.15); color:#64748B; }
    .sr-extra { display:flex; align-items:center; gap:6px; margin-top:4px; flex-wrap:wrap; }
    .sr-extra-badge { font-size:0.72rem; padding:2px 8px; border-radius:4px; font-weight:600; }
    .sr-extra-badge.out { background:rgba(212,196,252,.25); color:#7C3AED; }
    .sr-extra-site { font-size:0.78rem; color:#6D5EAE; font-weight:500; }
    .sr-extra-tm { font-size:0.75rem; color:#94A3B8; }
    .sr-empty { text-align:center; color:#94A3B8; font-size:0.88rem; padding:20px; }
    .sr-cal-hint { padding:12px 24px; background:rgba(180,206,249,.06); border-top:1px solid rgba(180,206,249,.1); display:flex; align-items:center; gap:8px; cursor:pointer; transition:background .15s; }
    .sr-cal-hint:hover { background:rgba(180,206,249,.12); }
    .sr-cal-hint svg { width:16px; height:16px; color:#B4CEF9; flex-shrink:0; fill:none; stroke:currentColor; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; }
    .sr-cal-hint span { font-size:0.78rem; color:#475569; font-weight:600; }
    .sr-cal-hint .arrow { color:#B4CEF9; margin-left:auto; }

    /* â”€â”€ í† ìŠ¤íŠ¸ íŒì—… â”€â”€ */
    .toast-pop{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0.8);
      background:#fff;border-radius:16px;padding:32px 36px;text-align:center;z-index:10002;
      box-shadow:0 12px 40px rgba(0,0,0,.18);opacity:0;pointer-events:none;transition:all .25s ease;}
    .toast-pop.show{opacity:1;transform:translate(-50%,-50%) scale(1);pointer-events:auto;}
    .toast-pop .tp-icon{width:48px;height:48px;border-radius:50%;background:#D1FAE5;
      display:inline-flex;align-items:center;justify-content:center;margin-bottom:12px;}
    .toast-pop .tp-icon svg{width:26px;height:26px;color:#059669;stroke:currentColor;fill:none;stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round;}
    .toast-pop .tp-msg{font-size:0.95rem;font-weight:700;color:#0F172A;margin-bottom:4px;}
    .toast-pop .tp-sub{font-size:0.78rem;color:#64748B;font-weight:500;}
    .toast-dim{position:fixed;inset:0;background:rgba(0,0,0,.25);z-index:10001;opacity:0;pointer-events:none;transition:opacity .25s;}
    .toast-dim.show{opacity:1;pointer-events:auto;}

    /* â”€â”€ ë ˆì´ì•„ì›ƒ â”€â”€ */
    .layout-side { display:flex; min-height:0; }
    .cal-main { flex:1; min-width:0; }
    .cal-wrap { padding:16px 20px 24px; overflow-x:auto; }
    .nav-bar { display:flex; align-items:center; justify-content:space-between; padding:0 0 14px; flex-wrap:wrap; gap:10px; }
    .m-nav { display:flex; align-items:center; gap:6px; }
    .nav-btn { width:30px; height:30px; border-radius:6px; border:1px solid #E2E8F0; background:#fff; cursor:pointer; font-size:15px; color:#64748B; display:flex; align-items:center; justify-content:center; transition:all .12s; }
    .nav-btn:hover { background:#F1F5F9; color:#0F172A; }
    .m-title { font-size:1rem; font-weight:700; min-width:110px; text-align:center; }
    .btn-today { font-size:0.72rem; font-weight:600; color:#3B82F6; background:#EFF6FF; border:1px solid #BFDBFE; border-radius:6px; padding:5px 12px; cursor:pointer; font-family:inherit; }
    .btn-today:hover { background:#DBEAFE; }
    .legend { display:flex; gap:14px; font-size:0.73rem; color:#475569; font-weight:500; }
    .legend span { display:flex; align-items:center; gap:5px; }
    .legend .bar { width:3px; height:12px; border-radius:2px; display:inline-block; }

    /* â”€â”€ í•„í„° + ì´ë¦„ê²€ìƒ‰ í•œ ì¤„ â”€â”€ */
    .filter-row { display:flex; align-items:center; justify-content:space-between; padding:0 0 14px; border-bottom:1px solid #F1F5F9; margin-bottom:14px; flex-wrap:wrap; gap:10px; }
    .filter-left { display:flex; align-items:center; gap:6px; }
    .filter-right { display:flex; align-items:center; gap:8px; }
    .filter-label { font-size:0.72rem; font-weight:700; color:#64748B; margin-right:4px; white-space:nowrap; }
    .ftab { display:flex; align-items:center; gap:6px; cursor:pointer; padding:7px 16px; border-radius:20px; border:1.5px solid #E2E8F0; background:#fff; font-size:0.78rem; font-weight:600; color:#64748B; transition:all .15s; user-select:none; }
    .ftab:hover { border-color:#CBD5E1; }
    .ftab.active { color:#fff; }
    .ftab.active.f-all { background:#0F172A; border-color:#0F172A; }
    .ftab.active.f-vac { background:#5B8DEF; border-color:#5B8DEF; }
    .ftab.active.f-out { background:#9B7EDE; border-color:#9B7EDE; }
    .ftab .td { width:6px; height:6px; border-radius:50%; }
    .ftab.f-all .td { background:#64748B; }
    .ftab.f-vac .td { background:#B4CEF9; }
    .ftab.f-out .td { background:#D4C4FC; }
    .ftab.active .td { background:rgba(255,255,255,.6); }

    /* â”€â”€ ì´ë¦„ í•„í„° â”€â”€ */
    .nf-label { font-size:0.72rem; font-weight:700; color:#94A3B8; white-space:nowrap; }
    .nf-wrap { position:relative; }
    .nf-input { width:180px; padding:7px 10px 7px 30px; border:1px solid #E2E8F0; border-radius:8px; font-size:0.8rem; font-family:inherit; color:#0F172A; background:#fff; }
    .nf-input:focus { outline:none; border-color:#B4CEF9; }
    .nf-input::placeholder { color:#CBD5E1; }
    .nf-icon { position:absolute; left:9px; top:50%; transform:translateY(-50%); width:14px; height:14px; color:#CBD5E1; fill:none; stroke:currentColor; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; }
    .nf-clear { font-size:0.7rem; color:#64748B; cursor:pointer; padding:4px 10px; border-radius:6px; border:none; background:#F1F5F9; font-family:inherit; display:none; font-weight:600; }
    .nf-clear.show { display:inline-block; }
    .nf-ind { display:none; font-size:0.72rem; color:#1E40AF; font-weight:700; background:rgba(180,206,249,.2); padding:5px 12px; border-radius:16px; white-space:nowrap; }
    .nf-ind.show { display:inline-flex; }

    /* â”€â”€ ìº˜ë¦°ë” â”€â”€ */
    .cal-head { display:grid; grid-template-columns:repeat(7,1fr); border-bottom:1px solid #E2E8F0; }
    .cal-head div { padding:10px 0; text-align:center; font-size:0.78rem; font-weight:600; color:#94A3B8; }
    .cal-head div:first-child { color:#EF4444; }
    .cal-head div:last-child { color:#3B82F6; }
    .cal-body { display:grid; grid-template-columns:repeat(7,1fr); }

    .cell { min-height:150px; border-right:1px solid #F1F5F9; border-bottom:1px solid #F1F5F9; padding:0; position:relative; overflow:hidden; cursor:pointer; transition:background .1s; display:flex; flex-direction:column; }
    .cell:hover { background:#FAFBFC; }
    .cell:nth-child(7n) { border-right:none; }
    .cell.other { background:#FAFBFC; cursor:default; }
    .cell.other:hover { background:#FAFBFC; }
    .cell.other .dn { color:#D1D5DB; }
    .cell.today { background:#EFF6FF; }
    .cell.today .dn { background:#0F172A; color:#fff; border-radius:50%; width:26px; height:26px; display:inline-flex; align-items:center; justify-content:center; font-weight:700; font-size:0.75rem; }
    .cell.sun { background:#F8F9FB; }
    .cell.sun:hover { background:#F3F4F6; }
    .cell.sun .dn { color:#EF4444; }
    .cell.sat { background:#F8F9FB; }
    .cell.sat:hover { background:#F3F4F6; }
    .cell.sat .dn { color:#3B82F6; }
    .cell.hol { background:#FFF5F5; }
    .cell.hol .dn { color:#EF4444; }
    .cell.sel { box-shadow:inset 0 0 0 2px #3B82F6; border-radius:2px; z-index:1; }
    .dn { font-size:0.8rem; font-weight:700; color:#475569; padding:6px 7px 2px; }
    .hol-name { font-size:0.55rem; color:#EF4444; padding:0 6px; font-weight:500; }

    /* â”€â”€ ì…€ ì¡´ (3ë¶„í• ) â”€â”€ */
    .split { flex:1; display:flex; flex-direction:column; margin-top:2px; }
    .zn3 { flex:1; padding:2px 6px; overflow:hidden; display:flex; flex-direction:column; justify-content:center; min-height:0; }
    .zn3:not(:last-child) { border-bottom:1px dashed #EBEBEB; }
    .zn3.vac { border-left:2.5px solid #85A8F0; }
    .zn3.half { border-left:2.5px solid #ECC468; }
    .zn3.half-am { border-left:2.5px solid #E8AE20; }
    .zn3.half-pm { border-left:2.5px solid #ECA510; }
    .zn3.out { border-left:2.5px solid #B89AF8; }
    .zn3.empty { border-left:2.5px solid #DCDCDC; }
    .zn3 .zl { font-size:0.52rem; font-weight:700; color:#B8B8B8; letter-spacing:0.3px; }
    .zn3.empty .zl { color:#E5E7EB; }
    .zn3 .znames { font-size:0.72rem; font-weight:500; color:#475569; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; line-height:1.3; font-family:'Noto Sans KR',sans-serif; letter-spacing:-0.2px; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .zn3 .znames .hl { color:#0F172A; font-weight:700; background:rgba(180,206,249,.3); padding:1px 3px; border-radius:2px; }
    .zn3.zone-hidden { display:none; }
    .split.out-only { justify-content:flex-start; }
    .split.out-only .zn3 { flex:0 0 auto; }
    /* â”€â”€ ì™¸ê·¼ ìƒì„¸ ì…€ (Level C) â”€â”€ */
    .split.out-only .zn3.out .out-items { display:flex; flex-direction:column; }
    .out-ci { padding:2px 0; }
    .out-ci:not(:last-child) { border-bottom:1px dotted #EDE9FE; }
    .out-ci .out-top { display:flex; align-items:center; gap:3px; }
    .out-ci .out-nm { font-size:0.58rem; font-weight:600; color:#6D5EAE; }
    .out-ci .out-tm { font-size:0.48rem; color:#9B7EDE; background:rgba(155,126,222,.12); padding:0 4px; border-radius:3px; line-height:1.5; }
    .out-ci .out-tb { font-size:0.44rem; padding:0 3px; border-radius:2px; line-height:1.5; }
    .out-ci .out-tb.pt { background:rgba(59,130,246,.1); color:#60A5FA; }
    .out-ci .out-tb.br { background:rgba(251,191,36,.1); color:#D97706; }
    .out-ci .out-tb.sm { background:rgba(168,85,247,.1); color:#A855F7; }
    .out-ci .out-tb.mt { background:rgba(236,72,153,.1); color:#EC4899; }
    .out-ci .out-tb.sl { background:rgba(34,197,94,.1); color:#22C55E; }
    .out-ci .out-tb.vs { background:rgba(20,184,166,.1); color:#14B8A6; }
    .out-ci .out-tb.df { background:rgba(239,68,68,.1); color:#EF4444; }
    .out-ci .out-tb.ct { background:rgba(249,115,22,.1); color:#F97316; }
    .out-ci .out-tb.pn { background:rgba(148,163,184,.1); color:#94A3B8; }
    .out-ci .out-tb.mn { background:rgba(16,185,129,.1); color:#34D399; }
    .out-ci .out-sn { font-size:0.48rem; color:#A89ED4; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .out-more { font-size:0.52rem; color:#9B7EDE; font-weight:600; text-align:center; padding:2px 0; cursor:pointer; background:rgba(155,126,222,.06); border-radius:3px; margin-top:1px; }
    .out-more:hover { background:rgba(155,126,222,.15); }
    /* â”€â”€ ì™¸ê·¼í˜„í™© ëª¨ë‹¬ ë‚´ë¶€ â”€â”€ */
    .om-item { display:flex; align-items:flex-start; gap:10px; padding:10px 12px; border-radius:8px; background:#F8FAFC; margin-bottom:6px; }
    .om-item .om-nm { font-size:0.88rem; font-weight:700; color:#334155; min-width:52px; }
    .om-item .om-info { flex:1; }
    .om-item .om-site { font-size:0.8rem; color:#6D5EAE; font-weight:500; }
    .om-item .om-meta { font-size:0.7rem; color:#94A3B8; margin-top:2px; display:flex; gap:8px; align-items:center; }
    .om-item .om-badge { font-size:0.65rem; padding:1px 6px; border-radius:4px; font-weight:600; }
    .om-item .om-badge.pt { background:rgba(59,130,246,.1); color:#3B82F6; }
    .om-item .om-badge.br { background:rgba(251,191,36,.1); color:#D97706; }
    .om-item .om-badge.mn { background:rgba(16,185,129,.1); color:#10B981; }

    /* ì™¸ê·¼ ëª¨ë‹¬ í™•ëŒ€ */
    .out-modal { max-width:620px !important; }
    .out-modal-header {
      display:flex; align-items:center; gap:14px; margin-bottom:20px;
      padding-bottom:16px; border-bottom:1px solid #F1F5F9;
    }
    .out-modal-header .om-date-badge {
      width:56px; height:56px; border-radius:14px;
      background:linear-gradient(135deg,#6D5EAE,#9B7EDE);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      color:#fff; flex-shrink:0;
    }
    .out-modal-header .om-date-badge .om-day { font-size:1.4rem; font-weight:800; line-height:1; }
    .out-modal-header .om-date-badge .om-dow { font-size:0.6rem; font-weight:500; opacity:.85; margin-top:2px; }
    .out-modal-header .om-title-area { flex:1; }
    .out-modal-header .om-title { font-size:1.1rem; font-weight:700; color:#0F172A; }
    .out-modal-header .om-count { font-size:0.8rem; color:#9B7EDE; font-weight:600; margin-top:2px; }
    .om-item-lg { display:flex; align-items:flex-start; gap:14px; padding:14px 16px; border-radius:10px; background:#F8FAFC; margin-bottom:8px; transition:background .15s; }
    .om-item-lg:hover { background:#F1F0FF; }
    .om-item-lg .om-avatar {
      width:36px; height:36px; border-radius:10px;
      background:linear-gradient(135deg,#B4CEF9,#D4C4FC);
      display:flex; align-items:center; justify-content:center;
      font-size:0.8rem; font-weight:700; color:#fff; flex-shrink:0;
    }
    .om-item-lg .om-detail { flex:1; }
    .om-item-lg .om-nm-lg { font-size:0.95rem; font-weight:700; color:#334155; }
    .om-item-lg .om-site-lg { font-size:0.82rem; color:#6D5EAE; font-weight:500; margin-top:2px; }
    .om-item-lg .om-meta-lg { font-size:0.72rem; color:#94A3B8; margin-top:4px; display:flex; gap:8px; align-items:center; }
    .om-item-lg .om-badge-lg, .dm-person .om-badge-lg { font-size:0.68rem; padding:2px 8px; border-radius:4px; font-weight:600; }
    .om-badge-lg.pt { background:rgba(59,130,246,.15); color:#3B82F6; }
    .om-badge-lg.br { background:rgba(251,191,36,.15); color:#D97706; }
    .om-badge-lg.sm { background:rgba(168,85,247,.15); color:#8B5CF6; }
    .om-badge-lg.mt { background:rgba(236,72,153,.15); color:#EC4899; }
    .om-badge-lg.sl { background:rgba(34,197,94,.15); color:#16A34A; }
    .om-badge-lg.vs { background:rgba(20,184,166,.15); color:#0D9488; }
    .om-badge-lg.df { background:rgba(239,68,68,.15); color:#DC2626; }
    .om-badge-lg.ct { background:rgba(249,115,22,.15); color:#EA580C; }
    .om-badge-lg.pn { background:rgba(148,163,184,.15); color:#64748B; }
    .om-badge-lg.mn { background:rgba(16,185,129,.15); color:#10B981; }
    .om-del-btn, .out-del-btn { position:absolute; right:8px; top:50%; transform:translateY(-50%); background:none; border:none; color:#CBD5E1; font-size:1.1rem; cursor:pointer; padding:4px 6px; border-radius:4px; line-height:1; }
    .om-del-btn:hover, .out-del-btn:hover { color:#EF4444; background:rgba(239,68,68,.08); }

    /* â”€â”€ í¬ê²Œë³´ê¸° ë²„íŠ¼ â”€â”€ */
    .sd-expand-btn { display:flex; align-items:center; justify-content:center; gap:5px; width:100%; padding:7px 0; margin-bottom:10px; border:1px solid #E2E8F0; border-radius:8px; background:#fff; color:#64748B; font-size:0.72rem; font-weight:600; cursor:pointer; font-family:inherit; transition:all .15s; }
    .sd-expand-btn:hover { background:#F8FAFC; color:#334155; border-color:#CBD5E1; }
    .sd-expand-btn svg { width:14px; height:14px; stroke:currentColor; fill:none; stroke-width:2; }

    /* ì¼ì í˜„í™© ëª¨ë‹¬ ì„¹ì…˜ */
    /* â”€â”€ V3: ì„¹ì…˜ ì „ì²´ ë°°ê²½ + ë¦¬ìŠ¤íŠ¸í˜• â”€â”€ */
    .dm-section-wrap { padding:16px; border-radius:12px; margin-bottom:14px; }
    .dm-section-wrap.vac-wrap { background:rgba(59,130,246,.04); border:1px solid rgba(59,130,246,.12); }
    .dm-section-wrap.half-wrap { background:rgba(245,158,11,.04); border:1px solid rgba(245,158,11,.12); }
    .dm-section-wrap.out-wrap { background:rgba(139,92,246,.04); border:1px solid rgba(139,92,246,.12); }
    .dm-section-hdr {
      display:flex; align-items:center; gap:8px; margin-bottom:10px;
      padding-bottom:10px; border-bottom:1px solid rgba(0,0,0,.06);
    }
    .dm-section-dot { width:10px; height:10px; border-radius:3px; flex-shrink:0; }
    .dm-section-dot.vac { background:#3B82F6; }
    .dm-section-dot.half { background:#F59E0B; }
    .dm-section-dot.out { background:#8B5CF6; }
    .dm-section-title { font-size:0.92rem; font-weight:800; color:#1E293B; }
    .dm-section-cnt { font-size:0.72rem; color:#94A3B8; font-weight:500; margin-left:4px; }
    .dm-person { display:flex; align-items:center; padding:10px 0; margin:0; border-radius:0; background:transparent; border-bottom:1px solid rgba(0,0,0,.04); }
    .dm-person:last-child { border-bottom:none; }
    .dm-person:hover { background:transparent; }
    .dm-person .dm-avatar { display:none; }
    .dm-person .dm-info { flex:1; }
    .dm-person .dm-info-row { display:flex; align-items:center; gap:12px; flex:1; }
    .dm-person .dm-nm { font-size:0.95rem; font-weight:700; color:#1E293B; min-width:60px; }
    .dm-person .dm-desc { font-size:0.8rem; color:#64748B; margin-top:0; }
    .dm-person .dm-site { font-size:0.82rem; color:#6D5EAE; font-weight:500; margin-top:0; }
    .dm-person .dm-meta-row { font-size:0.76rem; color:#64748B; margin-left:auto; display:flex; gap:8px; align-items:center; }
    .dm-empty { font-size:0.78rem; color:#CBD5E1; padding:6px 0; }

    /* â”€â”€ ì´ë¦„ í•„í„° ê°•ì¡° ëª¨ë“œ â”€â”€ */
    .cell.nf-hit { background:#FAFBFF; }
    .cell.nf-hit .split { flex:1; align-items:center; justify-content:center; }
    .nf-tag { display:inline-block; padding:3px 8px; border-radius:10px; font-size:0.58rem; font-weight:700; }
    .nf-sub { font-size:0.5rem; color:#64748B; margin-top:1px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .nf-type-badge { font-size:0.44rem; padding:1px 4px; border-radius:3px; font-weight:600; margin-left:2px; }
    .nf-type-badge.pt { background:rgba(59,130,246,.1); color:#60A5FA; }
    .nf-type-badge.br { background:rgba(251,191,36,.1); color:#D97706; }
    .nf-type-badge.sm { background:rgba(168,85,247,.1); color:#A855F7; }
    .nf-type-badge.mt { background:rgba(236,72,153,.1); color:#EC4899; }
    .nf-type-badge.sl { background:rgba(34,197,94,.1); color:#22C55E; }
    .nf-type-badge.vs { background:rgba(20,184,166,.1); color:#14B8A6; }
    .nf-type-badge.df { background:rgba(239,68,68,.1); color:#EF4444; }
    .nf-type-badge.ct { background:rgba(249,115,22,.1); color:#F97316; }
    .nf-type-badge.pn { background:rgba(148,163,184,.1); color:#94A3B8; }
    .nf-type-badge.mn { background:rgba(16,185,129,.1); color:#34D399; }
    .nf-tag.vac { background:rgba(180,206,249,.3); color:#1E40AF; }
    .nf-tag.half { background:rgba(250,224,160,.4); color:#92400E; }
    .nf-tag.out { background:rgba(212,196,252,.35); color:#5B21B6; }
    .nf-name { font-size:0.78rem; font-weight:800; color:#0F172A; text-align:center; margin-bottom:2px; }
    .cell.nf-miss { opacity:.3; }

    /* â”€â”€ ë‚ ì§œ ìƒì„¸ ì¸ë¼ì¸ â”€â”€ */
    .day-detail { border-top:1px solid #E2E8F0; padding:20px 28px; display:none; }
    .day-detail.open { display:block; }
    .dd-hd { display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; }
    .dd-hd h3 { font-size:1rem; font-weight:700; color:#0F172A; }
    .dd-sub { display:flex; gap:16px; font-size:0.8rem; color:#64748B; font-weight:500; }
    .dd-sub span { display:flex; align-items:center; gap:5px; }
    .dd-sub .dot { width:7px; height:7px; border-radius:50%; }
    .detail-item {
      padding:10px 14px; border-radius:8px; border-left:3px solid;
      background:#F8FAFC; margin-bottom:6px; transition:all .1s;
    }
    .detail-item:hover { background:#F1F5F9; }
    .detail-item.vac { border-color:#B4CEF9; }
    .detail-item.half { border-color:#FAE0A0; }
    .detail-item.out { border-color:#D4C4FC; }
    .detail-item.out-m { border-color:#D4C4FC; }
    .di-name { font-size:0.85rem; font-weight:600; color:#0F172A; }
    .di-type { font-size:0.75rem; color:#64748B; margin-top:2px; }
    .di-time { font-size:0.7rem; color:#94A3B8; margin-top:1px; }
    .di-link { font-size:0.75rem; color:#3B82F6; text-decoration:none; font-weight:600; }
    .di-link:hover { text-decoration:underline; }
    .no-ev { text-align:center; padding:24px 16px; color:#94A3B8; font-size:0.85rem; }

    /* â”€â”€ ì¢Œì¸¡ íŒ¨ë„ â”€â”€ */
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }
    .side-d { width:270px; min-width:270px; background:#F0F8FF; padding:24px 20px; flex-shrink:0; border:1.5px solid #BFDBFE; border-radius:14px; box-shadow:0 1px 6px rgba(144,202,249,.10); margin:8px 0 8px 8px; }
    .sd-hdr { background:linear-gradient(135deg,#0F172A,#1E3A5F); border-radius:12px; padding:18px 16px; margin-bottom:16px; color:#fff; }
    .sd-dr { display:flex; align-items:center; gap:8px; }
    .sd-live { width:8px; height:8px; background:#34D399; border-radius:50%; box-shadow:0 0 8px rgba(52,211,153,.5); animation:pulse 2s infinite; }
    .sd-date { font-size:1.1rem; font-weight:800; }
    .sd-day { font-size:0.72rem; color:#94A3B8; font-weight:500; }
    .sd-card { background:#fff; border-radius:10px; margin-bottom:8px; border:1px solid #E2E8F0; overflow:hidden; }
    .sd-ch { display:flex; align-items:center; gap:8px; padding:10px 14px; cursor:pointer; transition:background .1s; }
    .sd-ch:hover { background:#FAFBFC; }
    .sd-dot { width:8px; height:8px; border-radius:2px; flex-shrink:0; }
    .sd-dot.vac { background:#B4CEF9; }
    .sd-dot.half { background:#FAE0A0; }
    .sd-dot.out { background:#D4C4FC; }
    .sd-title { font-size:0.75rem; font-weight:700; color:#0F172A; }
    .sd-cnt { font-size:0.65rem; color:#94A3B8; margin-left:auto; font-weight:600; }
    .sd-arrow { font-size:0.7rem; color:#CBD5E1; transition:transform .2s; }
    .sd-ch.open .sd-arrow { transform:rotate(180deg); }
    .sd-list { padding:10px 14px 12px; border-top:1px solid #F1F5F9; }
    .sd-p { display:flex; align-items:center; gap:7px; padding:5px 0; font-size:0.8rem; }
    .sd-p .nm { color:#334155; font-weight:600; }
    .sd-p .dt { font-size:0.63rem; color:#94A3B8; margin-left:auto; }
    .sd-ch.vh { background:rgba(180,206,249,0.15); }
    .sd-ch.vh:hover { background:rgba(180,206,249,0.25); }
    .sd-ch.hh { background:rgba(250,224,160,0.18); }
    .sd-ch.hh:hover { background:rgba(250,224,160,0.3); }
    .sd-ch.oh { background:rgba(212,196,252,0.15); }
    .sd-ch.oh:hover { background:rgba(212,196,252,0.25); }
    .sd-p.out-detail { flex-direction:column; align-items:flex-start; gap:3px; padding:9px 10px; margin-bottom:8px; border-radius:6px; background:rgba(155,126,222,.06); }
    .sd-p.out-detail .out-row { display:flex; align-items:center; gap:6px; width:100%; }
    .sd-p.out-detail .out-time { font-size:0.65rem; color:#9B7EDE; background:rgba(155,126,222,.15); padding:1px 6px; border-radius:4px; white-space:nowrap; }
    .sd-p.out-detail .out-type { font-size:0.6rem; padding:1px 5px; border-radius:3px; white-space:nowrap; }
    .sd-p.out-detail .out-type.pt { background:rgba(59,130,246,.12); color:#60A5FA; }
    .sd-p.out-detail .out-type.br { background:rgba(251,191,36,.12); color:#FBBF24; }
    .sd-p.out-detail .out-type.sm { background:rgba(168,85,247,.12); color:#A855F7; }
    .sd-p.out-detail .out-type.mt { background:rgba(236,72,153,.12); color:#EC4899; }
    .sd-p.out-detail .out-type.sl { background:rgba(34,197,94,.12); color:#22C55E; }
    .sd-p.out-detail .out-type.vs { background:rgba(20,184,166,.12); color:#14B8A6; }
    .sd-p.out-detail .out-type.df { background:rgba(239,68,68,.12); color:#EF4444; }
    .sd-p.out-detail .out-type.ct { background:rgba(249,115,22,.12); color:#F97316; }
    .sd-p.out-detail .out-type.pn { background:rgba(148,163,184,.12); color:#94A3B8; }
    .sd-p.out-detail .out-type.manual { background:rgba(16,185,129,.12); color:#34D399; }
    .sd-p.out-detail .out-site { font-size:0.7rem; color:#8B7FC7; padding-left:2px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:100%; }
    .sd-sub { font-size:0.75rem; color:#475569; font-weight:800; padding:10px 14px 3px; letter-spacing:0.2px; display:flex; align-items:center; gap:6px; }
    .sd-sub::before { content:'\25B8'; color:#FAE0A0; font-size:0.85rem; flex-shrink:0; }

    /* â”€â”€ ëª¨ë‹¬ â”€â”€ */
    .modal-bg {
      position:fixed; inset:0; background:rgba(15,23,42,.4); backdrop-filter:blur(4px);
      display:none; align-items:center; justify-content:center; z-index:10000;
    }
    .modal-bg.show { display:flex; }
    .modal {
      background:#fff; border-radius:12px; width:92%; max-width:440px;
      padding:28px; position:relative; max-height:85vh; overflow-y:auto;
      box-shadow:0 20px 60px rgba(0,0,0,.15);
    }
    .modal h3 { font-size:1.05rem; font-weight:700; color:#0F172A; margin-bottom:20px; }
    .modal-close {
      position:absolute; top:18px; right:18px; width:28px; height:28px;
      border-radius:6px; background:#F1F5F9; border:none; color:#64748B;
      font-size:14px; cursor:pointer; display:flex; align-items:center; justify-content:center;
    }
    .modal-close:hover { background:#E2E8F0; color:#0F172A; }
    .fg { margin-bottom:14px; }
    .fg label { display:block; font-size:0.8rem; font-weight:600; color:#475569; margin-bottom:4px; }
    .fg input {
      width:100%; padding:9px 12px; border:1px solid #E2E8F0; border-radius:6px;
      font-size:0.85rem; font-family:inherit; color:#0F172A; background:#F8FAFC;
    }
    .fg input:focus { outline:none; border-color:#3B82F6; background:#fff; }
    /* â”€â”€ ì»¤ìŠ¤í…€ ë‚ ì§œ ì„ íƒ â”€â”€ */
    .dp-wrap { border:1px solid #E2E8F0; border-radius:8px; overflow:hidden; background:#fff; }
    .dp-input-row { display:flex; align-items:center; border-bottom:1px solid #F1F5F9; }
    .dp-input-row input { flex:1; border:none; padding:10px 12px; font-size:0.88rem; font-family:inherit; color:#0F172A; background:transparent; outline:none; }
    .dp-input-row input::placeholder { color:#CBD5E1; }
    .dp-input-row .dp-cal-btn { padding:8px 12px; background:none; border:none; cursor:pointer; font-size:1rem; color:#94A3B8; transition:color .15s; }
    .dp-input-row .dp-cal-btn:hover { color:#3B82F6; }
    .dp-input-row .dp-cal-btn.active { color:#3B82F6; }
    .dp-cal { display:none; padding:10px; }
    .dp-cal.open { display:block; }
    .dp-cal-hdr { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .dp-cal-hdr .dp-month { font-size:0.8rem; font-weight:700; color:#334155; }
    .dp-cal-hdr button { width:26px; height:26px; border:none; background:#F1F5F9; border-radius:6px; cursor:pointer; font-size:0.7rem; color:#64748B; display:flex; align-items:center; justify-content:center; }
    .dp-cal-hdr button:hover { background:#E2E8F0; }
    .dp-cal-days { display:grid; grid-template-columns:repeat(7,1fr); gap:1px; text-align:center; }
    .dp-cal-days .dp-wk { font-size:0.6rem; color:#94A3B8; font-weight:600; padding:4px 0; }
    .dp-cal-days .dp-wk:first-child { color:#EF4444; }
    .dp-cal-days .dp-d { font-size:0.72rem; padding:5px 0; border-radius:6px; cursor:pointer; color:#475569; transition:all .1s; }
    .dp-cal-days .dp-d:hover { background:#EFF6FF; color:#3B82F6; }
    .dp-cal-days .dp-d.sel { background:#3B82F6; color:#fff; font-weight:700; }
    .dp-cal-days .dp-d.today { font-weight:700; color:#3B82F6; }
    .dp-cal-days .dp-d.today.sel { color:#fff; }
    .dp-cal-days .dp-d.other { color:#D1D5DB; }
    .dp-cal-days .dp-d.sun { color:#EF4444; }
    .dp-cal-days .dp-d.sun.sel { color:#fff; }
    .dp-cal-days .dp-d.sat { color:#3B82F6; }
    .dp-cal-days .dp-d.sat.sel { color:#fff; }

    .fa { display:flex; gap:8px; justify-content:flex-end; margin-top:20px; }
    .btn-save {
      padding:9px 24px; border:none; border-radius:6px; font-size:0.85rem; font-weight:600;
      cursor:pointer; background:#3B82F6; color:#fff; font-family:inherit;
    }
    .btn-save:hover { background:#2563EB; }
    .btn-cancel {
      padding:9px 18px; border:1px solid #E2E8F0; border-radius:6px;
      font-size:0.85rem; font-weight:500; cursor:pointer; background:#fff;
      color:#64748B; font-family:inherit;
    }
    .btn-cancel:hover { background:#F8FAFC; }
    .ml { max-height:200px; overflow-y:auto; margin-top:12px; }
    .mi {
      display:flex; align-items:center; justify-content:space-between;
      padding:8px 12px; border-radius:6px; background:#F8FAFC; margin-bottom:4px; font-size:0.8rem;
    }
    .mi .del {
      background:none; border:none; color:#EF4444; cursor:pointer;
      font-size:14px; padding:2px 4px; border-radius:4px;
    }
    .mi .del:hover { background:#FEE2E2; }

    /* ë¡œë”© */
    .ld {
      position:fixed; inset:0; background:rgba(241,245,249,.92);
      display:flex; align-items:center; justify-content:center; z-index:9999;
      flex-direction:column; gap:12px;
    }
    .sp {
      width:32px; height:32px; border:3px solid #E2E8F0;
      border-top-color:#3B82F6; border-radius:50%; animation:spin .7s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }

    @media (max-width:768px) {
      .main-section { margin:8px; border-radius:10px; }
      .top-header { padding:8px 12px; height:auto; flex-wrap:wrap; gap:6px; }
      .top-header h1 { font-size:0.82rem; white-space:nowrap; flex-shrink:0; }
      .hdr-right { gap:5px; }
      .hdr-right .sync { font-size:0.6rem; display:none; }
      .hdr-btn { padding:4px 8px; font-size:0.68rem; white-space:nowrap; }
      .layout-side { flex-direction:column; }
      .side-d { width:100%; min-width:0; border:1.5px solid #BFDBFE; margin:8px; border-radius:14px; }
      .cell { min-height:70px; }
      .dn { font-size:0.7rem; padding:4px 5px 1px; }
      .zn3 .zl { font-size:0.45rem; }
      .zn3 .znames { font-size:0.55rem; font-weight:600; }
      .hol-name { font-size:0.45rem; }
      .search-area { padding:10px 12px 0; }
      .search-header { padding:12px 14px 10px; gap:10px; }
      .search-header-icon { width:32px; height:32px; border-radius:8px; }
      .search-header-title { font-size:0.88rem; }
      .search-header-desc { font-size:0.75rem; }
      .search-input-row { padding:0 14px 12px; }
      .search-input { padding:10px 36px 10px 38px; font-size:0.88rem; }
      .filter-row { flex-direction:column; align-items:flex-start; }
      .sr-card { padding:16px 14px; gap:12px; }
    }
    @media (max-width:480px) {
      .top-header h1 { font-size:0.75rem; }
      .hdr-btn { padding:3px 6px; font-size:0.62rem; }
      .cell { min-height:56px; }
      .zn3 { padding:1px 4px; }
      .zn3 .znames { font-size:0.5rem; font-weight:600; }
      .zn3 .zl { font-size:0.4rem; }
      .dn { font-size:0.65rem; padding:3px 4px 1px; }
    }
  </style>
</head>
<body>

<div id="loading" class="ld">
  <div class="sp"></div>
  <div style="font-size:0.8rem;color:#94A3B8;">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘</div>
</div>

<!-- ===== ìƒë‹¨ í—¤ë” ===== -->
<div class="top-header">
  <h1>(ì£¼) ë„·í¼ì•Œì•¤ë”” ê·¼ë¬´í˜„í™© ìº˜ë¦°ë”</h1>
  <div class="hdr-right">
    <span class="sync" id="syncInfo"></span>
    <button class="hdr-btn ghost" onclick="window.open('https://netformrnd.github.io/cal_guide/','_blank')">ğŸ“– ê°€ì´ë“œ</button>
    <button class="hdr-btn ghost" onclick="promptAdmin()">ê´€ë¦¬ì</button>
    <button class="hdr-btn ghost" onclick="loadData()">ìƒˆë¡œê³ ì¹¨</button>
  </div>
</div>

<!-- ===== ë©”ì¸ ì„¹ì…˜ ===== -->
<div class="main-section">

  <!-- ê²€ìƒ‰ -->
  <div class="search-area"><div class="search-card">
    <div class="search-header"><div class="search-header-icon"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></div><div><div class="search-header-title">ì´ë¦„ìœ¼ë¡œ ê·¼ë¬´ í˜„í™© ì¡°íšŒí•˜ê¸° <span id="searchClock" style="font-size:0.75rem;font-weight:500;color:#94A3B8;margin-left:6px;"></span></div><div class="search-header-desc">âš¡ ì¡°íšŒ ì‹œì ì„ ê¸°ì¤€ìœ¼ë¡œ í˜„ì¬ì˜ ê·¼ë¬´ ìƒíƒœë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.</div><div style="font-size:0.75rem;color:#475569;margin-top:2px;padding-left:14px;">ã„´ íœ´ê°€ í˜„í™©ì€ í•˜ì´ì›ìŠ¤ ê¸°ì¤€ì´ë©°, ê¸°ì•ˆ ë¯¸ì‘ì„± ì‹œ 'ê·¼ë¬´ ì¤‘'ìœ¼ë¡œ í‘œì‹œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div></div></div>
    <div class="search-input-row"><div class="search-input-wrap"><svg class="search-si" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input class="search-input" type="text" id="searchInput" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" oninput="doSearch()"><button class="search-clear" id="searchClear" onclick="clearSearch()">&times;</button></div></div>
    <div class="search-result" id="searchResult"></div>
  </div></div>

  <!-- ë ˆì´ì•„ì›ƒ -->
  <div class="layout-side">
    <!-- ì¢Œì¸¡ íŒ¨ë„ -->
    <div class="side-d" id="sidePanel" ondblclick="if(selDate)openDayPopup(selDate)"></div>

    <!-- ë‹¬ë ¥ -->
    <div class="cal-main"><div class="cal-wrap">
      <div class="nav-bar">
        <div class="m-nav">
          <button class="nav-btn" onclick="chgMonth(-1)">&#8249;</button>
          <div class="m-title" id="mTitle"></div>
          <button class="nav-btn" onclick="chgMonth(1)">&#8250;</button>
          <button class="btn-today" onclick="goToday()">ì˜¤ëŠ˜</button>
        </div>
        <div class="legend"><span><span class="bar" style="background:#B4CEF9"></span>ì—°ì°¨</span><span><span class="bar" style="background:#FAE0A0"></span>ë°˜ì°¨</span><span><span class="bar" style="background:#D4C4FC"></span>ì™¸ê·¼</span></div>
      </div>

      <!-- í•„í„° -->
      <div class="filter-row">
        <div class="filter-left">
          <div class="filter-label">ìƒì„¸ë³´ê¸°</div>
          <div class="ftab f-all active" onclick="setFilter('all')"><span class="td"></span>ì „ì²´</div>
          <div class="ftab f-vac" onclick="setFilter('vac')"><span class="td"></span>íœ´ê°€í˜„í™©</div>
          <div class="ftab f-out" onclick="setFilter('out')"><span class="td"></span>ì™¸ê·¼í˜„í™©</div>
        </div>
      </div>
      <!-- ì´ë¦„ í•„í„° + ì™¸ê·¼ë“±ë¡ -->
      <div class="filter-row" style="border-bottom:none;margin-bottom:8px;padding-bottom:0;">
        <div class="filter-left">
          <div class="nf-label">ì´ë¦„ í•„í„°</div>
          <div class="nf-wrap">
            <svg class="nf-icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input class="nf-input" type="text" id="nameFilter" placeholder="íŠ¹ì • ì¸ì› ì›”ê°„ í˜„í™©" oninput="applyNF()">
          </div>
          <button class="nf-clear" id="nfClear" onclick="clearNF()">âœ• ì´ˆê¸°í™”</button>
          <div class="nf-ind" id="nfInd"></div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:3px;">
          <button class="hdr-btn blue" style="font-size:0.72rem;padding:7px 14px;" onclick="openAddModal()">+ ì™¸ê·¼ë“±ë¡</button>
          <div style="font-size:0.68rem;color:#64748B;white-space:nowrap;text-align:right;background:#F8FAFC;padding:6px 10px;border-radius:6px;border:1px solid #E2E8F0;">ì„œë¹„ìŠ¤ìš´ì˜1íŒ€ ì™¸ê·¼ì€ <a href="https://schedules-cip.pages.dev/" target="_blank" style="color:#3B82F6;text-decoration:none;">ì˜ì—…ê´€ë¦¬</a>ì—ì„œ ìë™ì—°ë™ë©ë‹ˆë‹¤.<br>ë‹¤ë¥¸ ë¶€ì„œëŠ” ì—¬ê¸°ì„œ ì§ì ‘ ë“±ë¡í•´ ì£¼ì„¸ìš”.</div>
        </div>
      </div>

      <div class="cal-head"><div>ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div></div>
      <div class="cal-body" id="calBody"></div>
      <div style="text-align:right;padding:8px 12px 4px;font-size:0.65rem;color:#B0B8C4;">í•´ë‹¹ ì¼ìë¥¼ ë”ë¸”í´ë¦­í•˜ë©´ í¬ê²Œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>

      <!-- ë‚ ì§œ ìƒì„¸ëŠ” ì¢Œì¸¡ íŒ¨ë„ì—ì„œ í‘œì‹œ -->
    </div></div>
  </div>
</div>

<!-- ì™¸ê·¼ë“±ë¡ ëª¨ë‹¬ -->
<div class="modal-bg" id="addModal">
  <div class="modal" onclick="event.stopPropagation()">
    <button class="modal-close" onclick="closeAdd()">&times;</button>
    <h3>ì™¸ê·¼ ë“±ë¡</h3>
    <div class="fg"><label>ì´ë¦„</label><input type="text" id="mN" placeholder="í™ê¸¸ë™"></div>
    <div class="fg"><label>ë‚ ì§œ</label>
      <div class="dp-wrap">
        <div class="dp-input-row">
          <input type="text" id="mDInput" placeholder="2026-01-31 ë˜ëŠ” 20260131" maxlength="10" oninput="onDpInput(this)">
          <button class="dp-cal-btn" id="dpToggle" onclick="toggleDpCal()" title="ìº˜ë¦°ë”">ğŸ“…</button>
        </div>
        <div class="dp-cal" id="dpCal">
          <div class="dp-cal-hdr">
            <button onclick="dpNav(-1)">â—‚</button>
            <span class="dp-month" id="dpMonth"></span>
            <button onclick="dpNav(1)">â–¸</button>
          </div>
          <div class="dp-cal-days" id="dpDays"></div>
        </div>
      </div>
    </div>
    <div class="fg"><label>ì‹œê°„</label>
      <div style="display:flex;gap:8px;align-items:center;">
        <select id="mTS" style="flex:1;padding:9px 12px;border:1px solid #E2E8F0;border-radius:6px;font-size:0.85rem;font-family:inherit;color:#0F172A;background:#F8FAFC;"></select>
        <span style="color:#94A3B8;font-size:0.8rem;">~</span>
        <select id="mTE" style="flex:1;padding:9px 12px;border:1px solid #E2E8F0;border-radius:6px;font-size:0.85rem;font-family:inherit;color:#0F172A;background:#F8FAFC;"></select>
      </div>
    </div>
    <div class="fg"><label>ì¥ì†Œ</label><input type="text" id="mS" placeholder="ì˜ˆ: ì‚¼ì„±ë™ ë³¸ì‚¬"></div>
    <div class="fg"><label>ìƒì„¸ë‚´ì—­</label><input type="text" id="mM" placeholder="ì˜ˆ: ê±°ë˜ì²˜ ë¯¸íŒ…"></div>
    <div class="fa">
      <button class="btn-cancel" onclick="closeAdd()">ì·¨ì†Œ</button>
      <button class="btn-save" onclick="saveManual()">ë“±ë¡</button>
    </div>
    <div id="manualList" style="display:none;"></div>
  </div>
</div>

<!-- ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ -->
<div class="modal-bg" id="adminModal" onclick="closeAdminModal()">
  <div class="modal" style="max-width:360px;text-align:center;" onclick="event.stopPropagation()">
    <button class="modal-close" onclick="closeAdminModal()">&times;</button>
    <div style="margin-bottom:20px;">
      <div style="width:52px;height:52px;border-radius:14px;background:linear-gradient(135deg,#0F172A,#334155);display:inline-flex;align-items:center;justify-content:center;margin-bottom:14px;">
        <svg width="24" height="24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
      </div>
      <h3 style="margin-bottom:6px;">ê´€ë¦¬ì ì ‘ê·¼</h3>
      <p style="font-size:0.8rem;color:#94A3B8;margin:0;">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
    </div>
    <div class="fg" style="text-align:left;">
      <input type="password" id="adminPwInput" placeholder="ë¹„ë°€ë²ˆí˜¸" onkeydown="if(event.key==='Enter')submitAdmin()">
    </div>
    <div id="adminError" style="display:none;font-size:0.78rem;color:#EF4444;margin-bottom:12px;">ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
    <div class="fa" style="justify-content:center;">
      <button class="btn-cancel" onclick="closeAdminModal()">ì·¨ì†Œ</button>
      <button class="btn-save" onclick="submitAdmin()">í™•ì¸</button>
    </div>
  </div>
</div>

<!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
<div class="modal-bg" id="deleteConfirmModal" onclick="closeDeleteModal()">
  <div class="modal" style="max-width:360px;text-align:center;" onclick="event.stopPropagation()">
    <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
    <div style="margin-bottom:20px;">
      <div style="width:52px;height:52px;border-radius:14px;background:linear-gradient(135deg,#EF4444,#F87171);display:inline-flex;align-items:center;justify-content:center;margin-bottom:14px;">
        <svg width="24" height="24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
      </div>
      <h3 style="margin-bottom:6px;">ì‚­ì œ í™•ì¸</h3>
      <p style="font-size:0.85rem;color:#94A3B8;margin:0;">ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
    </div>
    <div class="fa" style="justify-content:center;">
      <button class="btn-cancel" onclick="closeDeleteModal()">ì·¨ì†Œ</button>
      <button class="btn-save" style="background:linear-gradient(135deg,#EF4444,#DC2626);" onclick="confirmDelete()">ì‚­ì œ</button>
    </div>
  </div>
</div>

<!-- ì™¸ê·¼í˜„í™© ëª¨ë‹¬ -->
<div class="modal-bg" id="outModal" onclick="closeOutModal()">
  <div class="modal out-modal" onclick="event.stopPropagation()">
    <button class="modal-close" onclick="closeOutModal()">&times;</button>
    <div id="outModalHeader" class="out-modal-header"></div>
    <div id="outModalBody"></div>
  </div>
</div>

<!-- ëª¨ë°”ì¼ ë‚ ì§œìƒì„¸ ëª¨ë‹¬ -->
<div class="modal-bg" id="dayMod" onclick="closeDM()">
  <div class="modal" onclick="event.stopPropagation()">
    <button class="modal-close" onclick="closeDM()">&times;</button>
    <h3 id="dmT"></h3>
    <div id="dmB"></div>
  </div>
</div>

<div class="toast-dim" id="toastDim"></div>
<div class="toast-pop" id="toastPop">
  <div class="tp-icon"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div>
  <div class="tp-msg" id="toastMsg">ë“±ë¡ ì™„ë£Œ!</div>
  <div class="tp-sub" id="toastSub"></div>
</div>

<script>
/* ===== Firebase Config ===== */
const FB_CONFIG={apiKey:"AIzaSyCzngaCcenhH1tmZ7syugpI3H1wYBVhiJQ",authDomain:"test-168a4.firebaseapp.com",databaseURL:"https://test-168a4-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"test-168a4",storageBucket:"test-168a4.firebasestorage.app",messagingSenderId:"955362696992",appId:"1:955362696992:web:234b098db17412be27c145"};
const MANUAL_KEY='company_outside_manual';

let cY, cM, userMap={}, vacData=[], salesOut=[], manualOut=[], holidayMap={}, editingId=null;
let curFilter='all', nameQ='', selDate=null, db=null;
let todayVacList=[], todaySalesOut=[], todayManualOut=[];
let ptCache=null, brCache=null, perCache=null; // PT/í˜„ì„¤/ê°œì¸ ì „ì²´ ìºì‹œ

/* ===== ì´ˆê¸°í™” ===== */
function init(){
  const app=firebase.initializeApp(FB_CONFIG,'calApp');
  db=firebase.database(app);
  const t=new Date(); cY=t.getFullYear(); cM=t.getMonth()+1;
  loadManual(); loadData();
}

/* ===== Firebase ë°ì´í„° ë¡œë“œ ===== */
async function loadData(){
  showLoading(true);
  try{
    const key=`${cY}-${p2(cM)}`, today=new Date(), todayKey=`${today.getFullYear()}-${p2(today.getMonth()+1)}`, todayStr=fmtDate(today);
    // íœ´ê°€+ê³µíœ´ì¼+ë©”íƒ€ ë¨¼ì € ë¡œë“œ (ë¹ ë¦„)
    const corePromises=[
      db.ref('/hiworks_vacation_sync/data/'+key).once('value'),
      db.ref('/hiworks_vacation_sync/users').once('value'),
      db.ref('/hiworks_vacation_sync/holidays/'+key).once('value'),
      db.ref('/hiworks_vacation_sync/meta/lastSync').once('value'),
      db.ref('/sq_vc/leaves').once('value'),
      db.ref('/manual_outside').once('value')
    ];
    if(todayKey!==key) corePromises.push(db.ref('/hiworks_vacation_sync/data/'+todayKey).once('value'));
    const coreResults=await Promise.all(corePromises);
    const[vacSnap,userSnap,holSnap,metaSnap,sqVcSnap,manualSnap]=coreResults;

    vacData=vacSnap.val()||[]; userMap=userSnap.val()||{};
    // ìˆ˜ë™ ì™¸ê·¼ Firebaseì—ì„œ ë¡œë“œ
    const manualData=manualSnap.val()||{};
    manualOut=Object.entries(manualData).map(([k,v])=>({...v,id:v.id||k}));
    holidayMap=holSnap.val()||{};
    // í•œêµ­ ê³µíœ´ì¼ í´ë°± (ìŒë ¥ ê³µíœ´ì¼ í¬í•¨)
    const koHolidays={
      '2025-01-01':'ì‹ ì •','2025-01-28':'ì„¤ë‚  ì—°íœ´','2025-01-29':'ì„¤ë‚ ','2025-01-30':'ì„¤ë‚  ì—°íœ´',
      '2025-03-01':'ì‚¼ì¼ì ˆ','2025-05-05':'ì–´ë¦°ì´ë‚ ','2025-05-06':'ëŒ€ì²´ê³µíœ´ì¼(ì–´ë¦°ì´ë‚ )',
      '2025-06-06':'í˜„ì¶©ì¼','2025-08-15':'ê´‘ë³µì ˆ','2025-10-03':'ê°œì²œì ˆ',
      '2025-10-05':'ì¶”ì„ ì—°íœ´','2025-10-06':'ì¶”ì„','2025-10-07':'ì¶”ì„ ì—°íœ´','2025-10-08':'ëŒ€ì²´ê³µíœ´ì¼(ì¶”ì„)',
      '2025-10-09':'í•œê¸€ë‚ ','2025-12-25':'ì„±íƒ„ì ˆ',
      '2026-01-01':'ì‹ ì •','2026-02-16':'ì„¤ë‚  ì—°íœ´','2026-02-17':'ì„¤ë‚ ','2026-02-18':'ì„¤ë‚  ì—°íœ´',
      '2026-03-01':'ì‚¼ì¼ì ˆ','2026-03-02':'ëŒ€ì²´ê³µíœ´ì¼(ì‚¼ì¼ì ˆ)','2026-05-05':'ì–´ë¦°ì´ë‚ ',
      '2026-06-06':'í˜„ì¶©ì¼','2026-08-15':'ê´‘ë³µì ˆ','2026-09-24':'ì¶”ì„ ì—°íœ´',
      '2026-09-25':'ì¶”ì„','2026-09-26':'ì¶”ì„ ì—°íœ´','2026-10-03':'ê°œì²œì ˆ',
      '2026-10-09':'í•œê¸€ë‚ ','2026-12-25':'ì„±íƒ„ì ˆ',
      '2027-01-01':'ì‹ ì •','2027-02-06':'ì„¤ë‚  ì—°íœ´','2027-02-07':'ì„¤ë‚ ','2027-02-08':'ì„¤ë‚  ì—°íœ´',
      '2027-03-01':'ì‚¼ì¼ì ˆ','2027-05-05':'ì–´ë¦°ì´ë‚ ','2027-06-06':'í˜„ì¶©ì¼',
      '2027-08-15':'ê´‘ë³µì ˆ','2027-10-03':'ê°œì²œì ˆ','2027-10-09':'í•œê¸€ë‚ ',
      '2027-10-14':'ì¶”ì„ ì—°íœ´','2027-10-15':'ì¶”ì„','2027-10-16':'ì¶”ì„ ì—°íœ´',
      '2027-12-25':'ì„±íƒ„ì ˆ'
    };
    Object.entries(koHolidays).forEach(([d,n])=>{if(!holidayMap[d])holidayMap[d]=n;});
    const mp=`${cY}-${p2(cM)}`;

    // sq_vc ì—°ì°¨ ë°ì´í„° ë³‘í•©
    const sqVcData=sqVcSnap.val()||{};
    Object.entries(sqVcData).forEach(([date,arr])=>{
      if(!Array.isArray(arr))return;
      arr.forEach(item=>{
        const vType=item.type==='full'?'ì—°ì°¨':item.type==='half'?'ë°˜ì°¨':item.type==='quarter'?'ë°˜ë°˜ì°¨':(item.label||'ì—°ì°¨');
        vacData.push({date:date, user_name:item.name, type_name:vType, src:'sq_vc'});
      });
    });

    const lastSync=metaSnap.val();
    document.getElementById('syncInfo').textContent=lastSync?'íœ´ê°€í˜„í™© ë™ê¸°í™” '+new Date(lastSync).toLocaleString('ko-KR',{month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'}):'';

    // ì˜¤ëŠ˜ íœ´ê°€ ë°ì´í„°
    let todayVacSource=vacData;
    if(todayKey!==key&&coreResults[6]){
      todayVacSource=coreResults[6].val()||[];
      // ë‹¤ë¥¸ ì›” ì¡°íšŒ ì‹œì—ë„ sq_vc ë°ì´í„°ë¥¼ ì˜¤ëŠ˜ íœ´ê°€ì— í¬í•¨
      Object.entries(sqVcData).forEach(([date,arr])=>{
        if(!Array.isArray(arr)||date!==todayStr)return;
        arr.forEach(item=>{
          const vType=item.type==='full'?'ì—°ì°¨':item.type==='half'?'ë°˜ì°¨':item.type==='quarter'?'ë°˜ë°˜ì°¨':(item.label||'ì—°ì°¨');
          todayVacSource.push({date:date, user_name:item.name, type_name:vType, src:'sq_vc'});
        });
      });
    }
    todayVacList=(Array.isArray(todayVacSource)?todayVacSource:[]).filter(v=>v.date===todayStr);
    todayManualOut=manualOut.filter(m=>m.date===todayStr);

    // ì™¸ê·¼ì€ ë¹ˆ ìƒíƒœë¡œ ë¨¼ì € ë Œë”ë§ (ë¹ ë¥¸ í™”ë©´ í‘œì‹œ)
    salesOut=[]; todaySalesOut=[];
    showLoading(false);
    render();
    updateSidePanel();
    if(selDate)selectDate(selDate);
    else{const t2=new Date();if(t2.getFullYear()===cY&&t2.getMonth()+1===cM)selectDate(fmtDate(t2));}

    // PT/í˜„ì„¤/ê°œì¸ ë°ì´í„° ë¹„ë™ê¸° ë¡œë“œ (ìºì‹œ ìˆìœ¼ë©´ ìŠ¤í‚µ)
    if(!ptCache||!brCache||!perCache){
      const[ptSnap2,brSnap2,perSnap2]=await Promise.all([
        ptCache?Promise.resolve(null):db.ref('/pt').once('value'),
        brCache?Promise.resolve(null):db.ref('/briefing').once('value'),
        perCache?Promise.resolve(null):db.ref('/personal').once('value')
      ]);
      if(ptSnap2) ptCache=ptSnap2.val()||{};
      if(brSnap2) brCache=brSnap2.val()||{};
      if(perSnap2) perCache=perSnap2.val()||{};
    }
    const ptData=ptCache||{}, brData=brCache||{}, perData=perCache||{};
    salesOut=[];
    Object.values(ptData).forEach(i=>{if(i.date&&i.date.startsWith(mp)&&i.ptAssignee)salesOut.push({date:i.date,name:i.ptAssignee,src:'sales',time:i.time||'',siteName:i.siteName||'',outType:'PT'});});
    Object.values(brData).forEach(i=>{if(i.date&&i.date.startsWith(mp)&&i.assignee)salesOut.push({date:i.date,name:i.assignee,src:'sales',time:i.time||'',siteName:i.siteName||'',outType:'í˜„ì„¤'});});
    // ê°œì¸ì¼ì • (ì—°ì°¨/íœ´ê°€ ì œì™¸) - titleì—ì„œ ì„¸ë¶€ìœ í˜• ì¶”ì¶œ
    Object.values(perData).forEach(i=>{
      if(!i.date||!i.date.startsWith(mp))return;
      const title=i.title||'';
      if(title.includes('ì—°ì°¨')||title.includes('íœ´ê°€'))return;
      const name=(i.assignees&&i.assignees[0])||'';
      if(!name)return;
      let outType=perType(title);
      let site=i.siteName||'';
      if(!site){
        let t=title;
        if(t.includes('_'))t=t.substring(t.indexOf('_')+1);
        t=t.replace(/\s*(ì„¸ë¯¸ë‚˜|ë¯¸íŒ…|ê³„ì•½|í˜„ì¥ë‹µì‚¬|ë°©ë¬¸|í•˜ì\s*ì ê²€|ì˜ì—…|í˜„ì„¤|PT|ë¸Œë¦¬í•‘|ê°œì¸|ì†”ë£¨ì…˜).*$/,'').trim();
        if(t&&t!==name) site=t;
        else site=i.location||'';
      }
      salesOut.push({date:i.date,name:name,src:'sales',time:i.time||'',siteName:site,outType:outType});
    });
    todaySalesOut=[];
    Object.values(ptData).forEach(i=>{if(i.date===todayStr&&i.ptAssignee)todaySalesOut.push({date:todayStr,name:i.ptAssignee,src:'sales',time:i.time||'',siteName:i.siteName||'',outType:'PT'});});
    Object.values(brData).forEach(i=>{if(i.date===todayStr&&i.assignee)todaySalesOut.push({date:todayStr,name:i.assignee,src:'sales',time:i.time||'',siteName:i.siteName||'',outType:'í˜„ì„¤'});});
    // ì˜¤ëŠ˜ ê°œì¸ì¼ì •
    Object.values(perData).forEach(i=>{
      if(i.date!==todayStr)return;
      const title=i.title||'';
      if(title.includes('ì—°ì°¨')||title.includes('íœ´ê°€'))return;
      const name=(i.assignees&&i.assignees[0])||'';
      if(!name)return;
      let outType=perType(title);
      let site=i.siteName||'';
      if(!site){
        let t=title;
        if(t.includes('_'))t=t.substring(t.indexOf('_')+1);
        t=t.replace(/\s*(ì„¸ë¯¸ë‚˜|ë¯¸íŒ…|ê³„ì•½|í˜„ì¥ë‹µì‚¬|ë°©ë¬¸|í•˜ì\s*ì ê²€|ì˜ì—…|í˜„ì„¤|PT|ë¸Œë¦¬í•‘|ê°œì¸|ì†”ë£¨ì…˜).*$/,'').trim();
        if(t&&t!==name) site=t;
        else site=i.location||'';
      }
      todaySalesOut.push({date:todayStr,name:name,src:'sales',time:i.time||'',siteName:site,outType:outType});
    });

    // ì™¸ê·¼ ë°ì´í„° ë°˜ì˜í•˜ì—¬ ë‹¤ì‹œ ë Œë”ë§
    render();
    updateSidePanel(selDate||undefined);
  }catch(e){console.error('ë¡œë“œ ì‹¤íŒ¨:',e);}
}

/* ===== ìœ í‹¸ ===== */
function fmtDate(d){return `${d.getFullYear()}-${p2(d.getMonth()+1)}-${p2(d.getDate())}`;}
function p2(n){return String(n).padStart(2,'0');}
function showLoading(s){document.getElementById('loading').style.display=s?'flex':'none';}
function perType(title){
  if(title.includes('ì„¸ë¯¸ë‚˜'))return'ì„¸ë¯¸ë‚˜';
  if(title.includes('ë¯¸íŒ…'))return'ë¯¸íŒ…';
  if(title.includes('ì˜ì—…'))return'ì˜ì—…';
  if(title.includes('ë°©ë¬¸')||title.includes('í˜„ì¥ë‹µì‚¬'))return'ë°©ë¬¸';
  if(title.includes('í•˜ìì ê²€')||title.includes('í•˜ì ì ê²€'))return'í•˜ìì ê²€';
  if(title.includes('ê³„ì•½'))return'ê³„ì•½';
  return'ê°œì¸';
}
function outTypeCls(t){if(t==='PT')return'pt';if(t==='í˜„ì„¤')return'br';if(t==='ì„¸ë¯¸ë‚˜')return'sm';if(t==='ë¯¸íŒ…')return'mt';if(t==='ì˜ì—…')return'sl';if(t==='ë°©ë¬¸')return'vs';if(t==='í•˜ìì ê²€')return'df';if(t==='ê³„ì•½')return'ct';if(t==='ê°œì¸')return'pn';return'pn';}

/* ===== ìˆ˜ë™ ì™¸ê·¼ (Firebase ê³µìœ ) ===== */
function loadManual(){
  if(!db)return;
  db.ref('/manual_outside').once('value').then(snap=>{
    const data=snap.val()||{};
    manualOut=Object.entries(data).map(([k,v])=>({...v,id:v.id||k}));
    showML();render();updateSidePanel();if(selDate)selectDate(selDate);
  }).catch(()=>{manualOut=[];});
}
function saveManualStore(){
  if(!db)return;
  const obj={};
  manualOut.forEach(m=>{obj[m.id]=m;});
  db.ref('/manual_outside').set(obj);
}
function initTimeSelects(){
  const opts=['<option value="">ì„ íƒ ì•ˆí•¨</option>'];
  for(let h=7;h<=21;h++) opts.push(`<option value="${p2(h)}:00">${p2(h)}:00</option>`);
  document.getElementById('mTS').innerHTML=opts.join('');
  document.getElementById('mTE').innerHTML=opts.join('');
}
/* ===== ì»¤ìŠ¤í…€ ë‚ ì§œ ì„ íƒ ===== */
let dpSelDate='', dpViewY=0, dpViewM=0;
function onDpInput(el){
  let v=el.value.replace(/[^0-9\-]/g,'');
  const digits=v.replace(/-/g,'');
  if(digits.length===8&&!v.includes('-')){
    v=digits.substring(0,4)+'-'+digits.substring(4,6)+'-'+digits.substring(6,8);
    el.value=v;
  }
  if(/^\d{4}-\d{2}-\d{2}$/.test(v)){
    dpSelDate=v;
    const dd=new Date(v+'T00:00:00');
    dpViewY=dd.getFullYear(); dpViewM=dd.getMonth()+1;
    renderDpCal();
  }
}
function toggleDpCal(){
  const cal=document.getElementById('dpCal');
  const btn=document.getElementById('dpToggle');
  const isOpen=cal.classList.toggle('open');
  btn.classList.toggle('active',isOpen);
  if(isOpen) renderDpCal();
}
function dpNav(dir){
  dpViewM+=dir;
  if(dpViewM>12){dpViewM=1;dpViewY++;}
  if(dpViewM<1){dpViewM=12;dpViewY--;}
  renderDpCal();
}
function dpPickDate(ds){
  dpSelDate=ds;
  document.getElementById('mDInput').value=ds;
  const dd=new Date(ds+'T00:00:00');
  dpViewY=dd.getFullYear(); dpViewM=dd.getMonth()+1;
  renderDpCal();
}
function renderDpCal(){
  const todayS=fmtDate(new Date());
  document.getElementById('dpMonth').textContent=`${dpViewY}ë…„ ${dpViewM}ì›”`;
  const first=new Date(dpViewY,dpViewM-1,1), last=new Date(dpViewY,dpViewM,0);
  const sDow=first.getDay(), tDays=last.getDate();
  const wks=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  let html=wks.map((w,i)=>`<div class="dp-wk${i===0?' sun':''}">${w}</div>`).join('');
  const prevLast=new Date(dpViewY,dpViewM-1,0).getDate();
  for(let i=sDow-1;i>=0;i--){
    html+=`<div class="dp-d other">${prevLast-i}</div>`;
  }
  for(let d=1;d<=tDays;d++){
    const ds=`${dpViewY}-${p2(dpViewM)}-${p2(d)}`;
    const dow=new Date(dpViewY,dpViewM-1,d).getDay();
    let cls='dp-d';
    if(ds===dpSelDate)cls+=' sel';
    if(ds===todayS)cls+=' today';
    if(dow===0)cls+=' sun';
    if(dow===6)cls+=' sat';
    html+=`<div class="${cls}" onclick="dpPickDate('${ds}')">${d}</div>`;
  }
  const rem=7-((sDow+tDays)%7);
  if(rem<7) for(let d=1;d<=rem;d++) html+=`<div class="dp-d other">${d}</div>`;
  document.getElementById('dpDays').innerHTML=html;
}
function initDp(dateStr){
  dpSelDate=dateStr;
  const dd=new Date(dateStr+'T00:00:00');
  dpViewY=dd.getFullYear(); dpViewM=dd.getMonth()+1;
  document.getElementById('mDInput').value=dateStr;
  document.getElementById('dpCal').classList.remove('open');
  document.getElementById('dpToggle').classList.remove('active');
}
function showToast(msg,sub,duration){
  try{
    const dim=document.getElementById('toastDim');
    const pop=document.getElementById('toastPop');
    if(!dim||!pop){console.error('toast elements not found');return;}
    document.getElementById('toastMsg').textContent=msg||'ë“±ë¡ ì™„ë£Œ!';
    document.getElementById('toastSub').textContent=sub||'';
    // ì´ì „ ìƒíƒœ ì´ˆê¸°í™” í›„ ë‹¤ìŒ í”„ë ˆì„ì—ì„œ show
    dim.classList.remove('show');pop.classList.remove('show');
    requestAnimationFrame(()=>{
      requestAnimationFrame(()=>{
        dim.classList.add('show');pop.classList.add('show');
        setTimeout(()=>{dim.classList.remove('show');pop.classList.remove('show');},duration||1800);
      });
    });
  }catch(e){console.error('showToast error:',e);}
}
function saveManual(){
  const name=document.getElementById('mN').value.trim();
  const date=document.getElementById('mDInput').value.trim();
  const timeStart=document.getElementById('mTS').value;
  const timeEnd=document.getElementById('mTE').value;
  const time=timeStart?(timeStart+(timeEnd?'~'+timeEnd:'')):'';
  const siteName=document.getElementById('mS').value.trim();
  const memo=document.getElementById('mM').value.trim();
  if(!name||!/^\d{4}-\d{2}-\d{2}$/.test(date)){alert('ì´ë¦„ê³¼ ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');return;}
  if(timeStart&&timeEnd&&timeStart>=timeEnd){alert('ì¢…ë£Œì‹œê°„ì€ ì‹œì‘ì‹œê°„ë³´ë‹¤ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤.');return;}
  const wasEditing=editingId!==null;
  const toastMsg=wasEditing?'ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤':'ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤';
  const timeInfo=time?` (${time})`:'';
  const toastSub=name+' Â· '+date+timeInfo;
  try{
    if(wasEditing){
      const idx=manualOut.findIndex(m=>m.id===editingId);
      if(idx>=0) manualOut[idx]={id:editingId,name,date,time,siteName,memo};
      editingId=null;
    } else {
      manualOut.push({id:Date.now(),name,date,time,siteName,memo});
    }
    saveManualStore();
  }catch(e){console.error('saveManual error:',e);}
  try{
    document.getElementById('mN').value='';
    document.getElementById('mTS').value='';
    document.getElementById('mTE').value='';
    document.getElementById('mS').value='';
    document.getElementById('mM').value='';
    closeAdd();
  }catch(e){console.error('closeAdd error:',e);}
  try{render();updateSidePanel();if(selDate)selectDate(selDate);}catch(e){console.error('render error:',e);}
  showToast(toastMsg,toastSub);
}
var pendingDeleteId=null;
function delManual(id){pendingDeleteId=id;document.getElementById('deleteConfirmModal').classList.add('show');}
function closeDeleteModal(){document.getElementById('deleteConfirmModal').classList.remove('show');pendingDeleteId=null;}
function confirmDelete(){if(pendingDeleteId!==null){manualOut=manualOut.filter(m=>String(m.id)!==String(pendingDeleteId));saveManualStore();showML();render();updateSidePanel();if(selDate)selectDate(selDate);}closeDeleteModal();}
function editManual(id){
  const m=manualOut.find(x=>x.id===id);
  if(!m)return;
  // ë‚ ì§œ ìƒì„¸ íŒì—… ë‹«ê¸°
  document.getElementById('outModal').style.display='none';
  // ëª¨ë‹¬ ì§ì ‘ ì—´ê¸° (openAddModal ê±°ì¹˜ì§€ ì•ŠìŒ)
  editingId=id;
  document.getElementById('addModal').classList.add('show');
  // ì‹œê°„ select ì˜µì…˜ ë¨¼ì € ë¹Œë“œ
  initTimeSelects();
  // ê¸°ì¡´ ë°ì´í„° ì±„ìš°ê¸°
  document.getElementById('mN').value=m.name||'';
  initDp(m.date||fmtDate(new Date()));
  document.getElementById('mS').value=m.siteName||'';
  document.getElementById('mM').value=m.memo||'';
  // ì‹œê°„ ì±„ìš°ê¸° (initTimeSelects ì´í›„)
  if(m.time&&m.time.includes('~')){
    const[s,e]=m.time.split('~');
    document.getElementById('mTS').value=s.trim();
    document.getElementById('mTE').value=e.trim();
  } else if(m.time){
    document.getElementById('mTS').value=m.time.trim();
    document.getElementById('mTE').value='';
  } else {
    document.getElementById('mTS').value='';
    document.getElementById('mTE').value='';
  }
  // ìˆ˜ì • ëª¨ë“œ UI
  document.getElementById('addModal').querySelector('h3').textContent='ì™¸ê·¼ ìˆ˜ì •';
  document.getElementById('addModal').querySelector('.btn-save').textContent='ìˆ˜ì •';
  showML();
}
function showML(){
  const el=document.getElementById('manualList'),mp=`${cY}-${p2(cM)}`;
  const items=manualOut.filter(m=>m.date.startsWith(mp));
  if(!items.length){el.innerHTML='<div style="text-align:center;color:#94A3B8;padding:16px;font-size:0.8rem;">ë“±ë¡ëœ ì™¸ê·¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';return;}
  el.innerHTML=items.sort((a,b)=>a.date.localeCompare(b.date)).map(m=>`<div class="mi"><span>${m.date.substring(5)}${m.time?' '+m.time:''} ${m.name}${m.siteName?' Â· '+m.siteName:''}${m.memo?' ('+m.memo+')':''}</span></div>`).join('');
}
function openAddModal(){editingId=null;document.getElementById('addModal').classList.add('show');document.getElementById('addModal').querySelector('h3').textContent='ì™¸ê·¼ ë“±ë¡';document.getElementById('addModal').querySelector('.btn-save').textContent='ë“±ë¡';initDp(selDate||fmtDate(new Date()));initTimeSelects();showML();}
function closeAdd(){editingId=null;document.getElementById('addModal').querySelector('h3').textContent='ì™¸ê·¼ ë“±ë¡';document.getElementById('addModal').querySelector('.btn-save').textContent='ë“±ë¡';document.getElementById('addModal').classList.remove('show');}

/* ===== ì´ë²¤íŠ¸ ë¶„ë¥˜ ===== */
function evCls(item){
  if(item._t==='out')return item.src==='manual'?'out-m':'out';
  const t=item.vacation_type_title||'';
  if(t.includes('ë°˜ì°¨')||t.includes('ë°˜ì¼'))return'half';
  return'vac';
}
function evName(item){
  if(item._t==='out')return item.name;
  return item.user_name||userMap[String(item.office_user_no)]||'?';
}
function isHalf(item){
  if(item._t!=='vac')return false;
  const t=item.vacation_type_title||'';
  const tn=item.type_name||'';
  if(t.includes('ë°˜ì°¨')||t.includes('ë°˜ì¼'))return true;
  if(tn.includes('ë°˜ì°¨')||tn.includes('ë°˜ë°˜ì°¨'))return true;
  // type=hours (ì‹œê°„ë‹¨ìœ„ ì‚¬ìš©)ì´ë©´ ë°˜ì°¨ ê³„ì—´ë¡œ íŒë‹¨ (ë°˜ë°˜ì°¨, ë°˜ì°¨, í¬ìƒ ë“±)
  if(item.type==='hours')return true;
  return false;
}
function isHalfHalf(item){
  // ë°˜ë°˜ì°¨: hoursê°€ 2 ì´í•˜ ë˜ëŠ” sq_vcì˜ ë°˜ë°˜ì°¨
  if(!isHalf(item))return false;
  if((item.type_name||'').includes('ë°˜ë°˜ì°¨'))return true;
  return item.type==='hours'&&item.hours&&item.hours<=2;
}
function isHalfAM(item){
  if(!isHalf(item))return false;
  const t=(item.vacation_type_title||'');
  if(t.includes('ì˜¤ì „'))return true;
  if(t.includes('ì˜¤í›„'))return false;
  // end_timeì´ 12:00 ì´í•˜ë©´ í™•ì‹¤íˆ ì˜¤ì „ë°˜ì°¨
  if(item.end_time&&item.end_time<='12:00:00')return true;
  // start_timeì´ 12:00 ì´ìƒì´ë©´ í™•ì‹¤íˆ ì˜¤í›„
  if(item.start_time&&item.start_time>='12:00:00')return false;
  // start_timeì´ ì˜¤ì „ì´ê³  end_timeì´ ì˜¤í›„ê¹Œì§€ ê±¸ì¹˜ëŠ” ê²½ìš°: ì‹œê°„ ì¤‘ì‹¬ì ìœ¼ë¡œ íŒë‹¨
  if(item.start_time&&item.end_time){
    const sh=parseInt(item.start_time),sm=parseInt(item.start_time.substring(3));
    const eh=parseInt(item.end_time),em=parseInt(item.end_time.substring(3));
    const mid=((sh*60+sm)+(eh*60+em))/2;
    return mid<720; // ì¤‘ì‹¬ì ì´ 12:00(720ë¶„) ë¯¸ë§Œì´ë©´ ì˜¤ì „
  }
  if(item.start_time)return item.start_time<'12:00:00';
  return false;
}
function isHalfPM(item){
  if(!isHalf(item))return false;
  return !isHalfAM(item);
}

function getEvents(ds){
  let ev=[];
  (Array.isArray(vacData)?vacData:[]).filter(v=>v.date===ds).forEach(v=>ev.push({...v,_t:'vac'}));
  salesOut.filter(o=>o.date===ds).forEach(o=>ev.push({...o,_t:'out',src:'sales'}));
  manualOut.filter(m=>m.date===ds).forEach(m=>ev.push({...m,_t:'out',src:'manual'}));
  return ev;
}
// ì…€ìš© ì™¸ê·¼ ìƒì„¸ HTML (Level C, ìµœëŒ€ maxShowëª… + ë”ë³´ê¸°)
function outCellHtml(outEvs,ds,maxShow){
  if(!maxShow)maxShow=4;
  if(!outEvs.length)return '<div class="zl">ì™¸ê·¼</div>';
  const show=outEvs.slice(0,maxShow), rest=outEvs.length-maxShow;
  let ih='<div class="zl">ì™¸ê·¼</div><div class="out-items">';
  show.forEach(o=>{
    const isSales=o.src==='sales';
    const typeCls=isSales?outTypeCls(o.outType):'mn';
    const typeLabel=isSales?(o.outType||'ì˜ì—…'):'';
    const tm=o.time&&o.time!=='ë¯¸ì •'?`<span class="out-tm">${o.time}</span>`:'';
    const site=o.siteName||(o.memo||'');
    ih+=`<div class="out-ci"><div class="out-top"><span class="out-nm">${o.name}</span>${tm}${typeLabel?`<span class="out-tb ${typeCls}">${typeLabel}</span>`:''}</div>${site?`<div class="out-sn">${site}</div>`:''}</div>`;
  });
  ih+='</div>';
  if(rest>0) ih+=`<div class="out-more" onclick="event.stopPropagation();openOutModal('${ds}')">+ ${rest}ëª… ë”ë³´ê¸°</div>`;
  return ih;
}

/* ===== ì´ë¦„ë³„ ë°˜ì°¨ í•©ì‚° ë¶„ë¥˜ ===== */
// halfItems: isHalf()ì¸ ì´ë²¤íŠ¸ ë°°ì—´, getNm: ì´ë¦„ ì¶”ì¶œ í•¨ìˆ˜
// return { fullDayNames: Set(ì—°ì°¨ë¡œ ì˜¬ë¼ê°ˆ ì´ë¦„), halfAM: [], halfPM: [] }
function classifyHalves(halfItems, getNm){
  const byName={};
  halfItems.forEach(e=>{
    const nm=getNm(e);
    if(!byName[nm])byName[nm]={totalH:0,items:[],am:[],pm:[]};
    byName[nm].totalH+=(e.hours||0);
    byName[nm].items.push(e);
    if(isHalfAM(e))byName[nm].am.push(e); else byName[nm].pm.push(e);
  });
  const fullDayNames=new Set();
  Object.keys(byName).forEach(nm=>{
    const info=byName[nm];
    // í•©ì‚° ì‹œê°„ì´ í•˜ë£¨ ê·¼ë¬´ì‹œê°„(8ì‹œê°„) ì´ìƒì´ë©´ ì—°ì°¨
    // ë˜ëŠ” ì˜¤ì „+ì˜¤í›„ ë™ì‹œ ì‚¬ìš©ì´ë©´ ì—°ì°¨
    if(info.totalH>=8 || (info.am.length&&info.pm.length)){
      fullDayNames.add(nm);
    }
  });
  const halfAM=halfItems.filter(e=>isHalfAM(e)&&!fullDayNames.has(getNm(e)));
  const halfPM=halfItems.filter(e=>isHalfPM(e)&&!fullDayNames.has(getNm(e)));
  return {fullDayNames, halfAM, halfPM};
}

/* ===== í•„í„° ===== */
function setFilter(f){
  curFilter=f;
  document.querySelectorAll('.ftab').forEach(t=>t.classList.remove('active'));
  document.querySelector('.ftab.f-'+f).classList.add('active');
  render();
  updateSidePanel(selDate||undefined);
}
function applyNF(){
  nameQ=document.getElementById('nameFilter').value.trim();
  const c=document.getElementById('nfClear'),ind=document.getElementById('nfInd');
  if(nameQ){c.classList.add('show');ind.textContent='\uD83D\uDC64 "'+nameQ+'" ì›”ê°„ í˜„í™©';ind.classList.add('show');}
  else{c.classList.remove('show');ind.classList.remove('show');}
  render();
}
function clearNF(){
  document.getElementById('nameFilter').value='';nameQ='';
  document.getElementById('nfClear').classList.remove('show');
  document.getElementById('nfInd').classList.remove('show');
  render();
}

/* ===== ë‹¬ë ¥ ë Œë”ë§ ===== */
function render(){
  const body=document.getElementById('calBody');body.innerHTML='';
  document.getElementById('mTitle').textContent=`${cY}ë…„ ${cM}ì›”`;
  const first=new Date(cY,cM-1,1),last=new Date(cY,cM,0);
  const sDow=first.getDay(),tDays=last.getDate(),todayS=fmtDate(new Date());
  const pl=new Date(cY,cM-1,0);
  for(let i=sDow-1;i>=0;i--)mkCell(body,pl.getDate()-i,true,null,todayS);
  for(let d=1;d<=tDays;d++)mkCell(body,d,false,`${cY}-${p2(cM)}-${p2(d)}`,todayS);
  const rem=7-((sDow+tDays)%7);if(rem<7)for(let d=1;d<=rem;d++)mkCell(body,d,true,null,todayS);
}

function mkCell(parent,day,isOther,ds,todayS){
  const c=document.createElement('div');c.className='cell'+(isOther?' other':'');
  const n=document.createElement('div');n.className='dn';n.textContent=day;c.appendChild(n);

  if(!isOther&&ds){
    const dow=new Date(cY,cM-1,day).getDay();
    if(dow===0)c.classList.add('sun');if(dow===6)c.classList.add('sat');
    if(ds===todayS)c.classList.add('today');if(ds===selDate)c.classList.add('sel');
    if(holidayMap[ds]){c.classList.add('hol');const hn=document.createElement('div');hn.className='hol-name';hn.textContent=holidayMap[ds];c.appendChild(hn);}

    const events=getEvents(ds);
    const fi=curFilter, nq=nameQ;
    const isVacOnly=fi==='vac', isOutOnly=fi==='out';

    // ë¶„ë¥˜ - ì´ë¦„ë³„ í•©ì‚°ìœ¼ë¡œ ì—°ì°¨/ë°˜ì°¨ íŒë‹¨
    const vacOrig=events.filter(e=>e._t==='vac'&&!isHalf(e));
    const halfAll=events.filter(e=>e._t==='vac'&&isHalf(e));
    const outEvs=events.filter(e=>e._t==='out');
    const cls=classifyHalves(halfAll,evName);
    const vacFull=[...vacOrig,...halfAll.filter(e=>cls.fullDayNames.has(evName(e)))];
    const halfAM=cls.halfAM, halfPM=cls.halfPM;
    const allHalf=[...halfAM,...halfPM];

    function flt(list){return nq?list.filter(x=>evName(x).includes(nq)):list;}

    // ì´ë¦„ í•„í„° ê°•ì¡° ëª¨ë“œ
    if(nq){
      const allEvs=[...events];
      const matched=allEvs.filter(e=>evName(e).includes(nq));
      if(matched.length){
        c.classList.add('nf-hit');
        const wrap=document.createElement('div');
        wrap.className='split';
        wrap.style.cssText='align-items:center;justify-content:center;text-align:center;padding:4px 4px;';
        // ìœ í˜• íŒë³„
        const tags=[];
        const matchedNm=evName(matched[0]);
        // ì—°ì°¨ ì²´í¬
        if(vacFull.some(e=>evName(e).includes(nq)))tags.push({label:'ì—°ì°¨',cls:'vac'});
        const myHalfAM=halfAM.filter(e=>evName(e).includes(nq));
        if(myHalfAM.length){
          const h=myHalfAM[0];
          const tm=h.end_time?h.end_time.substring(0,5)+' ì¶œê·¼':'';
          tags.push({label:'ì˜¤ì „ë°˜ì°¨',cls:'half',sub:tm?[tm]:[]});
        }
        const myHalfPM=halfPM.filter(e=>evName(e).includes(nq));
        if(myHalfPM.length){
          const h=myHalfPM[0];
          const tm=h.start_time?h.start_time.substring(0,5)+' í‡´ê·¼':'';
          tags.push({label:'ì˜¤í›„ë°˜ì°¨',cls:'half',sub:tm?[tm]:[]});
        }
        const myOut=outEvs.filter(e=>evName(e).includes(nq));
        if(myOut.length){
          const o=myOut[0];
          const isSales=o.src==='sales';
          const typeCls=isSales?outTypeCls(o.outType):'mn';
          const typeLabel=isSales?(o.outType||'ì˜ì—…'):'';
          const tm=o.time&&o.time!=='ë¯¸ì •'?o.time:'';
          const site=o.siteName||(o.memo||'');
          tags.push({label:'ì™¸ê·¼',cls:'out',typeCls,typeLabel,tm,site});
        }
        const nameHtml=`<div class="nf-name">${matchedNm}</div>`;
        const tagHtml=tags.map(t=>{
          let h=`<span class="nf-tag ${t.cls}">${t.label}</span>`;
          if(t.typeLabel) h+=`<span class="nf-type-badge ${t.typeCls}">${t.typeLabel}</span>`;
          if(t.sub&&t.sub.length) h+=`<div class="nf-sub">${t.sub.join(' Â· ')}</div>`;
          if(t.tm||t.site){
            const parts=[t.tm,t.site].filter(Boolean).join(' Â· ');
            h+=`<div class="nf-sub">${parts}</div>`;
          }
          return h;
        }).join('');
        wrap.innerHTML=nameHtml+tagHtml;
        c.appendChild(wrap);
      } else {
        c.classList.add('nf-miss');
        const wrap=document.createElement('div');wrap.className='split';
        function names2(list){
          if(!list.length)return{empty:true,html:''};
          const nms=[...new Set(list.map(e=>evName(e)))];
          return{empty:false,html:nms.join(', ')};
        }
        function addZ2(list,zcls,label,vis){
          const z=document.createElement('div');const r=names2(list);
          if(!vis){z.className='zn3 '+zcls+' zone-hidden';wrap.appendChild(z);return;}
          z.className='zn3 '+zcls+(r.empty?' empty':'');
          z.innerHTML=`<div class="zl">${label}</div>`+(r.empty?'':`<div class="znames">${r.html}</div>`);
          wrap.appendChild(z);
        }
        if(isVacOnly){addZ2(vacFull,'vac','ì—°ì°¨',true);addZ2(halfAM,'half-am','ì˜¤ì „ë°˜ì°¨',true);addZ2(halfPM,'half-pm','ì˜¤í›„ë°˜ì°¨',true);}
        else if(isOutOnly){
          const z2=document.createElement('div');
          z2.className='zn3 out'+(outEvs.length?'':' empty');
          z2.innerHTML=outCellHtml(outEvs,ds,4);
          wrap.appendChild(z2);
        }
        else{addZ2(vacFull,'vac','ì—°ì°¨',true);addZ2(allHalf,'half','ë°˜ì°¨',true);addZ2(outEvs,'out','ì™¸ê·¼',true);}
        c.appendChild(wrap);
      }
    } else {
      function names(list){
        const nl=list;
        if(!nl.length)return{empty:true,html:''};
        const nms=[...new Set(nl.map(e=>evName(e)))];
        return{empty:false,html:nms.join(', ')};
      }
      const wrap=document.createElement('div');
      wrap.className='split'+(isOutOnly?' out-only':'');

      function addZone(list,zcls,label,vis){
        const z=document.createElement('div');
        const r=names(list);
        if(!vis){z.className='zn3 '+zcls+' zone-hidden';wrap.appendChild(z);return;}
        z.className='zn3 '+zcls+(r.empty?' empty':'');
        z.innerHTML=`<div class="zl">${label}</div>`+(r.empty?'':`<div class="znames">${r.html}</div>`);
        wrap.appendChild(z);
      }

      if(isVacOnly){
        addZone(vacFull,'vac','ì—°ì°¨',true);
        addZone(halfAM,'half-am','ì˜¤ì „ë°˜ì°¨',true);
        addZone(halfPM,'half-pm','ì˜¤í›„ë°˜ì°¨',true);
      } else if(isOutOnly){
        // Level C: ì™¸ê·¼ ìƒì„¸ (ì´ë¦„+ì‹œê°„+ìœ í˜•+í˜„ì¥ëª…, ìµœëŒ€4ëª…+ë”ë³´ê¸°)
        const z=document.createElement('div');
        z.className='zn3 out'+(outEvs.length?'':' empty');
        z.innerHTML=outCellHtml(outEvs,ds,4);
        wrap.appendChild(z);
      } else {
        addZone(vacFull,'vac','ì—°ì°¨',true);
        addZone(allHalf,'half','ë°˜ì°¨',true);
        addZone(outEvs,'out','ì™¸ê·¼',true);
      }
      c.appendChild(wrap);
    }
    c.onclick=()=>selectDate(ds);
    c.ondblclick=()=>openDayPopup(ds);
  }
  parent.appendChild(c);
}

/* ===== ì¢Œì¸¡ íŒ¨ë„ (ì„ íƒ ë‚ ì§œ í˜„í™©) ===== */
function updateSidePanel(targetDate){
  const dayNames=['ì¼ìš”ì¼','ì›”ìš”ì¼','í™”ìš”ì¼','ìˆ˜ìš”ì¼','ëª©ìš”ì¼','ê¸ˆìš”ì¼','í† ìš”ì¼'];
  const panel=document.getElementById('sidePanel');

  // targetDateê°€ ì—†ìœ¼ë©´ ì˜¤ëŠ˜ ë‚ ì§œ ì‚¬ìš©
  const today=new Date();
  const todayStr=fmtDate(today);
  const ds=targetDate||todayStr;
  const d=new Date(ds+'T00:00:00');
  const isToday=(ds===todayStr);

  // í•´ë‹¹ ë‚ ì§œ ì´ë²¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
  let dateVacList, dateSalesOut, dateManualOut;
  if(isToday&&!targetDate){
    // ì´ˆê¸° ë¡œë“œ ì‹œ ì˜¤ëŠ˜ ë°ì´í„° (ë³„ë„ ë¡œë“œëœ ê²ƒ ì‚¬ìš©)
    dateVacList=todayVacList;
    dateSalesOut=todaySalesOut;
    dateManualOut=todayManualOut;
  } else {
    // ì„ íƒëœ ë‚ ì§œì˜ ì´ë²¤íŠ¸ë¥¼ getEventsë¡œ ê°€ì ¸ì˜¤ê¸°
    const events=getEvents(ds);
    dateVacList=events.filter(e=>e._t==='vac');
    dateSalesOut=events.filter(e=>e._t==='out'&&e.src==='sales');
    dateManualOut=events.filter(e=>e._t==='out'&&e.src==='manual');
  }

  // ë°ì´í„° ë¶„ë¥˜ - ì´ë¦„ë³„ í•©ì‚°ìœ¼ë¡œ ì—°ì°¨/ë°˜ì°¨ íŒë‹¨
  const vacOrig=dateVacList.filter(v=>!isHalf(v));
  const halfAllRaw=dateVacList.filter(v=>isHalf(v));
  const allOut=[...dateSalesOut,...dateManualOut];
  function sideVacName(v){return v.user_name||userMap[String(v.office_user_no)]||'?';}
  const cls=classifyHalves(halfAllRaw,sideVacName);
  const vacFull=[...vacOrig,...halfAllRaw.filter(v=>cls.fullDayNames.has(sideVacName(v)))];
  const halfAM=cls.halfAM, halfPM=cls.halfPM;
  const allHalf=[...halfAM,...halfPM];

  function pList(items,getN,getD){
    return items.map(i=>`<div class="sd-p"><span class="nm">${getN(i)}</span><span class="dt">${getD(i)}</span></div>`).join('');
  }
  // ì´ë¦„ ê¸°ì¤€ ê³ ìœ  ì¸ì›ìˆ˜ë¡œ ì¤‘ë³µ ì œê±°
  function uniqueNames(items,getN){return new Set(items.map(i=>getN(i))).size;}
  function vacName(v){return v.user_name||userMap[String(v.office_user_no)]||'?';}
  function vacDetail(v){
    if(v.type==='hours'&&v.start_time&&v.end_time)return `${v.start_time.substring(0,5)}~${v.end_time.substring(0,5)}`;
    return 'ì¢…ì¼';
  }
  function halfDetail(v){
    if(isHalfAM(v)){
      return v.end_time?v.end_time.substring(0,5)+' ì¶œê·¼':'ì˜¤ì „ë°˜ì°¨';
    }
    return v.start_time?v.start_time.substring(0,5)+' í‡´ê·¼':'ì˜¤í›„ë°˜ì°¨';
  }

  const liveDot=isToday?'<span class="sd-live"></span>':'';
  const dateLabel=`${d.getMonth()+1}ì›” ${d.getDate()}ì¼`;
  const dayLabel=dayNames[d.getDay()];
  const todayBadge=isToday?' <span style="font-size:0.6rem;background:#3B82F6;color:#fff;padding:2px 8px;border-radius:10px;margin-left:6px;">ì˜¤ëŠ˜</span>':'';

  const todayBtn=isToday?'':`<div style="margin-top:10px;"><button onclick="goToday()" style="width:100%;padding:8px;border:none;border-radius:8px;background:rgba(255,255,255,.15);color:#94A3B8;font-size:0.72rem;font-weight:600;cursor:pointer;font-family:inherit;transition:all .15s;border:1px solid rgba(255,255,255,.1);" onmouseover="this.style.background='rgba(255,255,255,.25)';this.style.color='#fff'" onmouseout="this.style.background='rgba(255,255,255,.15)';this.style.color='#94A3B8'">ğŸ“… ë‹¹ì¼ ê·¼ë¬´í˜„í™© ë³´ëŸ¬ê°€ê¸°</button></div>`;
  let html=`<div class="sd-hdr"><div class="sd-dr">${liveDot}<span class="sd-date">${dateLabel}${todayBadge}</span><span class="sd-day">${dayLabel}</span></div>${todayBtn}</div>`;
  html+=`<div style="text-align:center;font-size:0.65rem;color:#94A3B8;margin-bottom:10px;">í•˜ë‹¨ ì…€ì„ ë”ë¸”í´ë¦­í•˜ë©´ í¬ê²Œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>`;

  // ì—°ì°¨ ì¹´ë“œ - ì´ë¦„ë³„ í•©ì‚° ì‹œê°„ í‘œì‹œ
  // ê°™ì€ ì´ë¦„ì˜ ë°˜ì°¨ í•©ì‚°ìëŠ” ì‹œê°„ì„ í•©ì³ì„œ í‘œì‹œ
  function vacListHtml(items){
    const names=new Set();
    items.forEach(v=>names.add(vacName(v)));
    return [...names].map(nm=>{
      return `<div class="sd-p"><span class="nm">${nm}</span><span class="dt">ì¢…ì¼</span></div>`;
    }).join('');
  }
  const vacUniqueN=uniqueNames(vacFull,vacName);
  html+=`<div class="sd-card"><div class="sd-ch open vh"><span class="sd-dot vac"></span><span class="sd-title">ì—°ì°¨</span></div><div class="sd-list">${vacFull.length?vacListHtml(vacFull):'<div class="sd-p" style="color:#94A3B8;font-size:0.75rem;">ì—†ìŒ</div>'}</div></div>`;

  // ë°˜ì°¨ ì¹´ë“œ
  const halfUniqueN=uniqueNames(allHalf,vacName);
  html+=`<div class="sd-card"><div class="sd-ch open hh"><span class="sd-dot half"></span><span class="sd-title">ë°˜ì°¨</span></div><div class="sd-list">`;
  if(halfAM.length||halfPM.length){
    html+=`<div class="sd-sub">ì˜¤ì „</div>`;
    html+=halfAM.length?pList(halfAM,vacName,halfDetail):'<div class="sd-p" style="color:#CBD5E1;font-size:0.75rem;padding-left:6px;">ì—†ìŒ</div>';
    html+=`<div class="sd-sub">ì˜¤í›„</div>`;
    html+=halfPM.length?pList(halfPM,vacName,halfDetail):'<div class="sd-p" style="color:#CBD5E1;font-size:0.75rem;padding-left:6px;">ì—†ìŒ</div>';
  } else {
    html+='<div class="sd-p" style="color:#94A3B8;font-size:0.75rem;">ì—†ìŒ</div>';
  }
  html+=`</div></div>`;

  // ì™¸ê·¼ ì¹´ë“œ
  function outListHtml(items){
    if(!items.length)return '<div class="sd-p" style="color:#94A3B8;font-size:0.75rem;">ì—†ìŒ</div>';
    return items.map(o=>{
      const isSales=o.src==='sales';
      const isManual=o.src==='manual';
      const typeCls=isSales?outTypeCls(o.outType):'manual';
      const typeLabel=isSales?(o.outType||'ì˜ì—…'):'';
      const timeBadge=o.time&&o.time!=='ë¯¸ì •'?`<span class="out-time">${o.time}</span>`:'';
      const site=o.siteName||(o.memo||'');
      return `<div class="sd-p out-detail"><div class="out-row"><span class="nm">${o.name}</span>${timeBadge}${typeLabel?`<span class="out-type ${typeCls}">${typeLabel}</span>`:''}</div>${site?`<div class="out-site">${site}</div>`:''}</div>`;
    }).join('');
  }
  const outUniqueN=new Set(allOut.map(o=>o.name)).size;
  html+=`<div class="sd-card"><div class="sd-ch open oh"><span class="sd-dot out"></span><span class="sd-title">ì™¸ê·¼</span></div><div class="sd-list">${outListHtml(allOut)}</div></div>`;

  panel.innerHTML=html;
}

function toggleCard(el){
  el.classList.toggle('open');
  el.nextElementSibling.style.display=el.classList.contains('open')?'':'none';
}

/* ===== ì™¸ê·¼í˜„í™© ëª¨ë‹¬ ===== */
function openOutModal(ds){
  const events=getEvents(ds);
  const outEvs=events.filter(e=>e._t==='out');
  const d=new Date(ds+'T00:00:00');
  const dayNames=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  // í—¤ë”: ë‚ ì§œ ë±ƒì§€ + íƒ€ì´í‹€
  document.getElementById('outModalHeader').innerHTML=
    `<div class="om-date-badge"><div class="om-day">${d.getDate()}</div><div class="om-dow">${dayNames[d.getDay()]}ìš”ì¼</div></div>`+
    `<div class="om-title-area"><div class="om-title">${d.getFullYear()}ë…„ ${d.getMonth()+1}ì›” ${d.getDate()}ì¼ ì™¸ê·¼ í˜„í™©</div></div>`;
  let html='';
  if(!outEvs.length){html='<div style="text-align:center;color:#94A3B8;padding:32px 0;font-size:0.9rem;">ì™¸ê·¼ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';}
  else{
    outEvs.forEach(o=>{
      const isSales=o.src==='sales';
      const typeCls=isSales?outTypeCls(o.outType):'mn';
      const typeLabel=isSales?(o.outType||'ì˜ì—…'):'';
      const tm=o.time&&o.time!=='ë¯¸ì •'?o.time:'';
      const site=o.siteName||(o.memo||'');
      const initial=o.name?o.name.charAt(0):'';
      const isManual=o.src==='manual';
      const delBtn=isManual?`<button class="om-del-btn" onclick="event.stopPropagation();delManual(${o.id});openOutModal('${ds}')" title="ì‚­ì œ">&times;</button>`:'';
      const dblAction=isManual?` ondblclick="editManual(${o.id})" title="ë”ë¸”í´ë¦­í•˜ì—¬ ìˆ˜ì •" style="cursor:pointer;position:relative;"`:'';
      html+=`<div class="om-item-lg"${dblAction}><div class="om-avatar">${initial}</div><div class="om-detail"><div class="om-nm-lg">${o.name}</div>${site?`<div class="om-site-lg">${site}</div>`:''}<div class="om-meta-lg">${tm?`<span>${tm}</span>`:''}${typeLabel?`<span class="om-badge-lg ${typeCls}">${typeLabel}</span>`:''}${o.memo&&o.src==='manual'?`<span>${o.memo}</span>`:''}</div></div>${delBtn}</div>`;
    });
  }
  document.getElementById('outModalBody').innerHTML=html;
  document.getElementById('outModal').style.display='flex';
}
function closeOutModal(){document.getElementById('outModal').style.display='none';}

function openDayModal(ds){
  const events=getEvents(ds);
  const d=new Date(ds+'T00:00:00');
  const dayNames=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  // ë¶„ë¥˜
  const vacAll=events.filter(e=>e._t==='vac');
  const outEvs=events.filter(e=>e._t==='out');
  const vacOrig=vacAll.filter(v=>!isHalf(v));
  const halfAllRaw=vacAll.filter(v=>isHalf(v));
  function gn(v){return v.user_name||userMap[String(v.office_user_no)]||'?';}
  const cls2=classifyHalves(halfAllRaw,gn);
  const vacFull=[...vacOrig,...halfAllRaw.filter(v=>cls2.fullDayNames.has(gn(v)))];
  const halfAM=cls2.halfAM, halfPM=cls2.halfPM;
  const allHalf=[...halfAM,...halfPM];
  const vacUniqueN=new Set(vacFull.map(v=>gn(v))).size;
  const halfUniqueN=new Set(allHalf.map(v=>gn(v))).size;
  const outUniqueN=new Set(outEvs.map(o=>o.name)).size;
  // í—¤ë”
  document.getElementById('outModalHeader').innerHTML=
    `<div class="om-date-badge"><div class="om-day">${d.getDate()}</div><div class="om-dow">${dayNames[d.getDay()]}ìš”ì¼</div></div>`+
    `<div class="om-title-area"><div class="om-title">${d.getFullYear()}ë…„ ${d.getMonth()+1}ì›” ${d.getDate()}ì¼ ê·¼ë¬´ í˜„í™©</div></div>`;
  let html='';
  // ì—°ì°¨ ì„¹ì…˜
  // ì—°ì°¨ ì„¹ì…˜
  const vacNames=new Set(vacFull.map(v=>gn(v)));
  html+=`<div class="dm-section-wrap vac-wrap"><div class="dm-section-hdr"><span class="dm-section-dot vac"></span><span class="dm-section-title">ì—°ì°¨</span><span class="dm-section-cnt">(${vacNames.size}ëª…)</span></div>`;
  if(!vacFull.length){html+=`<div class="dm-empty">ì—†ìŒ</div>`;}
  else{
    const byNm={};
    vacFull.forEach(v=>{const nm=gn(v);if(!byNm[nm])byNm[nm]={starts:[],ends:[],isDay:false};if(v.type==='days')byNm[nm].isDay=true;else if(v.type==='hours'&&v.start_time&&v.end_time){byNm[nm].starts.push(v.start_time);byNm[nm].ends.push(v.end_time);}});
    Object.keys(byNm).forEach(nm=>{
      const info=byNm[nm];let dt='ì¢…ì¼';
      if(!info.isDay&&info.starts.length){dt=info.starts.sort()[0].substring(0,5)+'~'+info.ends.sort().reverse()[0].substring(0,5);}
      html+=`<div class="dm-person"><div class="dm-info-row"><div class="dm-nm">${nm}</div><div class="dm-desc">${dt}</div></div></div>`;
    });
  }
  html+=`</div>`;
  // ë°˜ì°¨ ì„¹ì…˜
  const halfNames=new Set(allHalf.map(v=>gn(v)));
  html+=`<div class="dm-section-wrap half-wrap"><div class="dm-section-hdr"><span class="dm-section-dot half"></span><span class="dm-section-title">ë°˜ì°¨</span><span class="dm-section-cnt">(${halfNames.size}ëª…)</span></div>`;
  if(!allHalf.length){html+=`<div class="dm-empty">ì—†ìŒ</div>`;}
  else{
    halfAM.forEach(v=>{
      const nm=gn(v);const desc=v.end_time?v.end_time.substring(0,5)+' ì¶œê·¼':'ì˜¤ì „ë°˜ì°¨';
      html+=`<div class="dm-person"><div class="dm-info-row"><div class="dm-nm">${nm}</div><div class="dm-desc">ì˜¤ì „ë°˜ì°¨ Â· ${desc}</div></div></div>`;
    });
    halfPM.forEach(v=>{
      const nm=gn(v);const desc=v.start_time?v.start_time.substring(0,5)+' í‡´ê·¼':'ì˜¤í›„ë°˜ì°¨';
      html+=`<div class="dm-person"><div class="dm-info-row"><div class="dm-nm">${nm}</div><div class="dm-desc">ì˜¤í›„ë°˜ì°¨ Â· ${desc}</div></div></div>`;
    });
  }
  html+=`</div>`;
  // ì™¸ê·¼ ì„¹ì…˜
  const outNames=new Set(outEvs.map(o=>o.name));
  html+=`<div class="dm-section-wrap out-wrap"><div class="dm-section-hdr"><span class="dm-section-dot out"></span><span class="dm-section-title">ì™¸ê·¼</span><span class="dm-section-cnt">(${outNames.size}ëª…)</span></div>`;
  if(!outEvs.length){html+=`<div class="dm-empty">ì—†ìŒ</div>`;}
  else{
    outEvs.forEach(o=>{
      const isSales=o.src==='sales';
      const typeCls=isSales?outTypeCls(o.outType):'mn';
      const typeLabel=isSales?(o.outType||'ì˜ì—…'):'';
      const tm=o.time&&o.time!=='ë¯¸ì •'?o.time:'';
      const site=o.siteName||(o.memo||'');
      const metaParts=[];
      if(typeLabel) metaParts.push(`<span class="om-badge-lg ${typeCls}">${typeLabel}</span>`);
      if(tm) metaParts.push(`<span>${tm}</span>`);
      if(o.memo&&o.src==='manual') metaParts.push(`<span>${o.memo}</span>`);
      const isManual=o.src==='manual';
      const delBtn=isManual?`<button class="om-del-btn" onclick="event.stopPropagation();delManual(${o.id});openDayModal('${ds}')" title="ì‚­ì œ" style="position:relative;">&times;</button>`:'';
      const dblAction=isManual?` ondblclick="editManual(${o.id})" title="ë”ë¸”í´ë¦­í•˜ì—¬ ìˆ˜ì •" style="cursor:pointer;"`:'';
      html+=`<div class="dm-person"${dblAction}><div class="dm-info-row"><div class="dm-nm">${o.name}</div>${site?`<div class="dm-site">${site}</div>`:''}<div class="dm-meta-row">${metaParts.join('')}</div></div>${delBtn}</div>`;
    });
  }
  html+=`</div>`;
  document.getElementById('outModalBody').innerHTML=html;
  document.getElementById('outModal').style.display='flex';
}

function openVacModal(ds){
  const events=getEvents(ds);
  const d=new Date(ds+'T00:00:00');
  const dayNames=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  const vacAll=events.filter(e=>e._t==='vac');
  const vacOrig=vacAll.filter(v=>!isHalf(v));
  const halfAllRaw=vacAll.filter(v=>isHalf(v));
  function gn(v){return v.user_name||userMap[String(v.office_user_no)]||'?';}
  const cls2=classifyHalves(halfAllRaw,gn);
  const vacFull=[...vacOrig,...halfAllRaw.filter(v=>cls2.fullDayNames.has(gn(v)))];
  const halfAM=cls2.halfAM, halfPM=cls2.halfPM;
  const allHalf=[...halfAM,...halfPM];
  const vacUniqueN=new Set(vacFull.map(v=>gn(v))).size;
  const halfUniqueN=new Set(allHalf.map(v=>gn(v))).size;
  document.getElementById('outModalHeader').innerHTML=
    `<div class="om-date-badge" style="background:linear-gradient(135deg,#60A5FA,#3B82F6)"><div class="om-day">${d.getDate()}</div><div class="om-dow">${dayNames[d.getDay()]}ìš”ì¼</div></div>`+
    `<div class="om-title-area"><div class="om-title">${d.getFullYear()}ë…„ ${d.getMonth()+1}ì›” ${d.getDate()}ì¼ íœ´ê°€ í˜„í™©</div></div>`;
  let html='';
  // ì—°ì°¨
  html+=`<div class="dm-section"><div class="dm-section-hdr"><span class="dm-section-dot vac"></span><span class="dm-section-title">ì—°ì°¨</span></div>`;
  if(!vacFull.length){html+=`<div class="dm-empty">ì—†ìŒ</div>`;}
  else{
    const byNm={};
    vacFull.forEach(v=>{const nm=gn(v);if(!byNm[nm])byNm[nm]={starts:[],ends:[],isDay:false};if(v.type==='days')byNm[nm].isDay=true;else if(v.type==='hours'&&v.start_time&&v.end_time){byNm[nm].starts.push(v.start_time);byNm[nm].ends.push(v.end_time);}});
    Object.keys(byNm).forEach(nm=>{
      const info=byNm[nm];let dt='ì¢…ì¼';
      if(!info.isDay&&info.starts.length){dt=info.starts.sort()[0].substring(0,5)+'~'+info.ends.sort().reverse()[0].substring(0,5);}
      html+=`<div class="dm-person"><div class="dm-avatar vac">${nm.charAt(0)}</div><div class="dm-info"><div class="dm-nm">${nm}</div><div class="dm-desc">${dt}</div></div></div>`;
    });
  }
  html+=`</div>`;
  // ë°˜ì°¨
  html+=`<div class="dm-section"><div class="dm-section-hdr"><span class="dm-section-dot half"></span><span class="dm-section-title">ë°˜ì°¨</span></div>`;
  if(!allHalf.length){html+=`<div class="dm-empty">ì—†ìŒ</div>`;}
  else{
    halfAM.forEach(v=>{
      const nm=gn(v);const desc=v.end_time?v.end_time.substring(0,5)+' ì¶œê·¼':'ì˜¤ì „ë°˜ì°¨';
      html+=`<div class="dm-person"><div class="dm-avatar half">${nm.charAt(0)}</div><div class="dm-info"><div class="dm-nm">${nm}</div><div class="dm-desc">ì˜¤ì „ë°˜ì°¨ Â· ${desc}</div></div></div>`;
    });
    halfPM.forEach(v=>{
      const nm=gn(v);const desc=v.start_time?v.start_time.substring(0,5)+' í‡´ê·¼':'ì˜¤í›„ë°˜ì°¨';
      html+=`<div class="dm-person"><div class="dm-avatar half">${nm.charAt(0)}</div><div class="dm-info"><div class="dm-nm">${nm}</div><div class="dm-desc">ì˜¤í›„ë°˜ì°¨ Â· ${desc}</div></div></div>`;
    });
  }
  html+=`</div>`;
  document.getElementById('outModalBody').innerHTML=html;
  document.getElementById('outModal').style.display='flex';
}

/* ===== ë‚ ì§œ ì„ íƒ ===== */
function selectDate(ds){
  selDate=ds;const d=new Date(ds+'T00:00:00');
  updateSidePanel(ds);
  document.querySelectorAll('.cell.sel').forEach(c=>c.classList.remove('sel'));
  const cells=document.querySelectorAll('.cell:not(.other)');
  if(cells[d.getDate()-1])cells[d.getDate()-1].classList.add('sel');
}
function openDayPopup(ds){
  if(curFilter==='out') openOutModal(ds);
  else if(curFilter==='vac') openVacModal(ds);
  else openDayModal(ds);
}

/* ===== ìƒë‹¨ ê²€ìƒ‰ ===== */
function doSearch(){
  const q=document.getElementById('searchInput').value.trim();
  const el=document.getElementById('searchResult');
  const cb=document.getElementById('searchClear');
  if(!q){el.classList.remove('show');cb.classList.remove('show');return;}
  cb.classList.add('show');

  const todayStr=fmtDate(new Date());
  const allEvents=getEvents(todayStr);

  // ëª¨ë“  ì‚¬ìš©ì ëª©ë¡ (userMapì—ì„œ)
  let foundName=null, status=null;
  const allNames=Object.values(userMap);
  foundName=allNames.find(nm=>nm.includes(q));

  // ê²€ìƒ‰ ì‹œì ì˜ ìµœì‹  ìˆ˜ë™ì™¸ê·¼ ë°ì´í„° ì‚¬ìš©
  const searchManualOut=manualOut.filter(m=>m.date===todayStr);
  if(!foundName){
    // ì™¸ê·¼ìì—ì„œë„ ì°¾ê¸°
    const outMatch=[...todaySalesOut,...searchManualOut].find(o=>o.name.includes(q));
    if(outMatch)foundName=outMatch.name;
  }

  if(foundName){
    // ì˜¤ëŠ˜ ìƒíƒœ í™•ì¸ - í•´ë‹¹ ì´ë¦„ì˜ ëª¨ë“  íœ´ê°€ ë§¤ì¹­
    const vacMatches=todayVacList.filter(v=>{
      const nm=v.user_name||userMap[String(v.office_user_no)]||'';
      return nm===foundName;
    }).map(v=>v._t?v:{...v,_t:'vac'});
    const outMatch=[...todaySalesOut,...searchManualOut].find(o=>o.name===foundName);

    const now=new Date();
    const nowHHMM=p2(now.getHours())+':'+p2(now.getMinutes());
    const isAMnow=now.getHours()<12;
    const dayOfWeek=now.getDay(); // 0=ì¼, 6=í† 
    const isWeekend=dayOfWeek===0||dayOfWeek===6;
    const isHolidayToday=holidayMap[todayStr];
    const isBeforeWork=nowHHMM<'08:00';
    const isAfterWork=nowHHMM>='17:31';
    const isOffHours=isWeekend||isHolidayToday||isBeforeWork||isAfterWork;

    let label='ê·¼ë¬´ì¤‘', cls='working', detail='';
    if(vacMatches.length){
      // ì¢…ì¼ ì—°ì°¨ ì²´í¬
      const fullDay=vacMatches.find(v=>!isHalf(v));
      if(fullDay){
        label='ì—°ì°¨';cls='vac';detail='ì¢…ì¼ ì—°ì°¨';
      } else {
        // ë°˜ì°¨ë“¤ í•©ì‚° ë¶„ë¥˜
        const halfItems=vacMatches.filter(v=>isHalf(v));
        const searchGetNm=v=>v.user_name||userMap[String(v.office_user_no)]||'?';
        const sCls=classifyHalves(halfItems,searchGetNm);
        const isFullDay=sCls.fullDayNames.has(foundName);
        const amHalves=isFullDay?[]:sCls.halfAM;
        const pmHalves=isFullDay?[]:sCls.halfPM;
        if(isFullDay){
          label='ì—°ì°¨';cls='vac';detail='ì—°ì°¨ (ë°˜ì°¨ í•©ì‚°)';
        } else if(amHalves.length){
          const h=amHalves[0];
          const timeInfo=h.start_time&&h.end_time?h.start_time.substring(0,5)+'~'+h.end_time.substring(0,5):'ì˜¤ì „';
          // í˜„ì¬ ì‹œê°„ì´ ë°˜ì°¨ ì¢…ë£Œ ì´í›„ë©´ â†’ ê·¼ë¬´ì¤‘
          if(h.end_time&&nowHHMM>=h.end_time.substring(0,5)){
            label='ê·¼ë¬´ì¤‘';cls='working';detail=`ê·¼ë¬´ì¤‘ (ì˜¤ì „ë°˜ì°¨ : ${timeInfo})`;
          } else {
            label='ì˜¤ì „ë°˜ì°¨';cls='half-am';detail=`ì˜¤ì „ë°˜ì°¨ : ${timeInfo}`;
          }
        } else if(pmHalves.length){
          const h=pmHalves[0];
          const timeInfo=h.start_time&&h.end_time?h.start_time.substring(0,5)+'~'+h.end_time.substring(0,5):'ì˜¤í›„';
          // í˜„ì¬ ì‹œê°„ì´ ë°˜ì°¨ ì‹œì‘ ì „ì´ë©´ â†’ ê·¼ë¬´ì¤‘
          if(h.start_time&&nowHHMM<h.start_time.substring(0,5)){
            label='ê·¼ë¬´ì¤‘';cls='working';detail=`ê·¼ë¬´ì¤‘ (ì˜¤í›„ë°˜ì°¨ : ${timeInfo})`;
          } else {
            label='ì˜¤í›„ë°˜ì°¨';cls='half-pm';detail=`ì˜¤í›„ë°˜ì°¨ : ${timeInfo}`;
          }
        }
      }
    } else if(outMatch){
      // ì™¸ê·¼ ì‹œê°„ ë²”ìœ„ í™•ì¸í•˜ì—¬ í˜„ì¬ ì™¸ê·¼ì¤‘ì¸ì§€ íŒë‹¨
      const allOutNow=[...todaySalesOut,...searchManualOut].filter(o=>o.name===foundName);
      let isCurrentlyOut=false, hasUpcomingOut=false, allOutDone=true;
      allOutNow.forEach(o=>{
        const t=o.time||'';
        if(!t){isCurrentlyOut=true;allOutDone=false;}
        else if(t.includes('~')){
          const[s,e]=t.split('~').map(x=>x.trim());
          if(s&&e&&nowHHMM>=s&&nowHHMM<=e){isCurrentlyOut=true;allOutDone=false;}
          else if(s&&nowHHMM<s){hasUpcomingOut=true;allOutDone=false;}
        } else if(t.match(/^\d{1,2}:\d{2}$/)){
          if(nowHHMM>=t){isCurrentlyOut=true;allOutDone=false;}
          else{hasUpcomingOut=true;allOutDone=false;}
        } else {isCurrentlyOut=true;allOutDone=false;}
      });
      if(isCurrentlyOut){
        label='ì™¸ê·¼';cls='out';detail='';
      } else if(hasUpcomingOut){
        label='ê·¼ë¬´ì¤‘';cls='working';detail='ì™¸ê·¼ì˜ˆì •';
      } else if(allOutDone){
        label='ê·¼ë¬´ì¤‘';cls='working';detail='ì™¸ê·¼ì™„ë£Œ';
      } else {
        label='ì™¸ê·¼';cls='out';detail='';
      }
    }
    // ê·¼ë¬´ì‹œê°„ ì™¸ ìµœì¢… ì²´í¬ (ê·¼ë¬´ì¤‘/ì™¸ê·¼ â†’ ê·¼ë¬´ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤, ì—°ì°¨ëŠ” ìœ ì§€)
    if(isOffHours&&(cls==='working'||cls==='out')){
      // ì™¸ê·¼ ë“±ë¡ì´ ìˆìœ¼ë©´ ì‹œê°„ ë²”ìœ„ ì•ˆì´ë©´ ì™¸ê·¼ ìœ ì§€, ì‹œê°„ ë¯¸ì§€ì •ì´ë©´ í•­ìƒ ì™¸ê·¼ ìœ ì§€
      let stillOut=false;
      if(cls==='out'){
        const allOutNow=[...todaySalesOut,...searchManualOut].filter(o=>o.name===foundName);
        allOutNow.forEach(o=>{
          const t=o.time||'';
          if(!t){
            stillOut=true;
          } else if(t.includes('~')){
            const[s,e]=t.split('~');
            if(s&&e&&nowHHMM>=s.trim()&&nowHHMM<=e.trim())stillOut=true;
          } else if(t.match(/^\d{1,2}:\d{2}$/)){
            if(nowHHMM>=t)stillOut=true;
          }
        });
      }
      if(!stillOut){
        const prevDetail=detail||'';
        label='ê·¼ë¬´ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤';cls='off-hours';
        detail=isWeekend?'ì£¼ë§':(isHolidayToday?'ê³µíœ´ì¼':'');
        if(prevDetail)detail+=(detail?' Â· ':'')+prevDetail.replace('ê·¼ë¬´ì¤‘ ','').replace('(','').replace(')','');
      }
    }
    // ì™¸ê·¼+ë°˜ì°¨ ë™ì‹œ ì²´í¬
    const allOutMatches=[...todaySalesOut,...searchManualOut].filter(o=>o.name===foundName);
    let extraOutHtml='';
    if(allOutMatches.length&&cls!=='out'){
      extraOutHtml=allOutMatches.map(o=>{
        const oType=o.outType||'';
        const oTm=o.time&&o.time!=='ë¯¸ì •'?o.time:'';
        const oSite=o.siteName||(o.memo||'');
        const isSales=o.src==='sales';
        const typeCls2=isSales?outTypeCls(o.outType):'mn';
        return `<div class="sr-extra">${oType?`<span class="om-badge-lg ${typeCls2}">${oType}</span>`:''}${oSite?`<span class="sr-extra-site">${oSite}</span>`:''}${oTm?`<span class="sr-extra-tm">${oTm}</span>`:''}</div>`;
      }).join('');
    }
    // ì™¸ê·¼ ìƒì„¸ (ì™¸ê·¼ ìƒíƒœì¼ ë•Œ)
    let outDetailHtml='';
    if(cls==='out'&&allOutMatches.length){
      outDetailHtml=allOutMatches.map(o=>{
        const isSales=o.src==='sales';
        const typeCls2=isSales?outTypeCls(o.outType):'mn';
        const oType=o.outType||'';
        const oTm=o.time&&o.time!=='ë¯¸ì •'?o.time:'';
        const oSite=o.siteName||(o.memo||'');
        return `<div class="sr-extra">${oType?`<span class="om-badge-lg ${typeCls2}">${oType}</span>`:''}${oSite?`<span class="sr-extra-site">${oSite}</span>`:''}${oTm?`<span class="sr-extra-tm">${oTm}</span>`:''}</div>`;
      }).join('');
    }
    const initial=foundName.charAt(0);
    const nowStamp=now.getFullYear()+'.'+p2(now.getMonth()+1)+'.'+p2(now.getDate())+' '+p2(now.getHours())+':'+p2(now.getMinutes());
    const isOnLeave=cls==='vac'||cls==='half-am'||cls==='half-pm';
    const isWorking=cls==='working';
    const cardCls=isOnLeave?' on-leave':(isWorking?' on-work':'');
    const avatarStyle=isOnLeave?'background:linear-gradient(135deg,#FDA4AF,#FECDD3);box-shadow:0 2px 8px rgba(253,164,175,.3);':(isWorking?'background:linear-gradient(135deg,#6EE7B7,#A7F3D0);box-shadow:0 2px 8px rgba(110,231,183,.3);':'');
    el.innerHTML=`<div style="padding:10px 24px 0;font-size:0.72rem;color:#94A3B8;display:flex;align-items:center;gap:5px;"><span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:${isOnLeave?'#F87171':'#34D399'};"></span> ${nowStamp} ê¸°ì¤€ ê·¼ë¬´í˜„í™©</div><div class="sr-card${cardCls}"><div class="sr-avatar"${avatarStyle?' style="'+avatarStyle+'"':''}>${initial}</div><div class="sr-info"><div class="sr-name">${foundName}</div>${detail?`<div class="sr-detail">${detail}</div>`:''}${outDetailHtml}${extraOutHtml}</div><div class="sr-badge ${cls}">${label}</div></div>
    <div class="sr-cal-hint" onclick="document.getElementById('nameFilter').value='${foundName}';applyNF();document.getElementById('calBody').scrollIntoView({behavior:'smooth'})"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span>${foundName}ë‹˜ì˜ ì›”ê°„ í˜„í™©ì„ ë‹¬ë ¥ì—ì„œ ë³´ê¸°</span><span class="arrow">\u2192</span></div>`;
    el.classList.add('show');
  } else {
    el.innerHTML=`<div class="sr-empty">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>`;el.classList.add('show');
  }
}
function clearSearch(){
  const inp=document.getElementById('searchInput');
  inp.value='';
  document.getElementById('searchResult').classList.remove('show');
  document.getElementById('searchClear').classList.remove('show');
  inp.focus();
}

/* ===== ë„¤ë¹„ê²Œì´ì…˜ ===== */
function chgMonth(d){cM+=d;if(cM>12){cM=1;cY++;}if(cM<1){cM=12;cY--;}selDate=null;loadData();}
function goToday(){const t=new Date();cY=t.getFullYear();cM=t.getMonth()+1;selDate=fmtDate(t);loadData();}
function closeDM(){document.getElementById('dayMod').classList.remove('show');}
function promptAdmin(){
  document.getElementById('adminPwInput').value='';
  document.getElementById('adminError').style.display='none';
  document.getElementById('adminModal').classList.add('show');
  setTimeout(()=>document.getElementById('adminPwInput').focus(),100);
}
function closeAdminModal(){
  document.getElementById('adminModal').classList.remove('show');
}
function submitAdmin(){
  const pw=document.getElementById('adminPwInput').value;
  if(pw==='ice080303!'){closeAdminModal();location.href='admin-sync.html';}
  else{document.getElementById('adminError').style.display='block';document.getElementById('adminPwInput').value='';document.getElementById('adminPwInput').focus();}
}

/* ===== ê²€ìƒ‰ ì˜ì—­ ì‹œê³„ ===== */
function updateSearchClock(){
  const n=new Date();
  const el=document.getElementById('searchClock');
  if(el)el.textContent=n.getFullYear()+'.'+p2(n.getMonth()+1)+'.'+p2(n.getDate())+' '+p2(n.getHours())+':'+p2(n.getMinutes());
}
setInterval(updateSearchClock,1000);

document.addEventListener('keydown',function(e){
  if(e.key==='Escape'){
    if(document.getElementById('deleteConfirmModal').classList.contains('show'))closeDeleteModal();
    if(document.getElementById('adminModal').classList.contains('show'))closeAdminModal();
    if(document.getElementById('outModal').style.display==='flex')closeOutModal();
    if(document.getElementById('addModal').classList.contains('show'))closeAdd();
  }
  if(e.key==='Enter'){
    var addM=document.getElementById('addModal');
    if(addM.classList.contains('show')&&addM.contains(document.activeElement)&&document.activeElement.tagName==='INPUT'){
      e.preventDefault();saveManual();
    }
  }
});

/* ===== ì‹œì‘ ===== */
init();
updateSearchClock();
</script>
</body>
</html>
